
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.parser.Parser;
import org.jsoup.parser.ParserMode;
import org.junit.Test;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import static org.junit.Assert.assertEquals;

public class JsoupResponseHeadersTest {

    @Test
    public void testDuplicateTupleInResponseHeader() {
        String html = "<http://01pt.com/>\n" +
                "Cache-Control:no-store, no-cache, must-revalidate, post-check=0, pre-check=0\n" +
                "Content-Encoding:gzip\n" +
                "Content-Length:16224\n" +
                "Content-Type:text/html;charset=gb2312\n" +
                "Date:Thu, 27 Aug 2015 09:22:40 GMT\n" +
                "Expires:Thu, 19 Nov 1981 08:52:00 GMT\n" +
                "Pragma:no-cache\n" +
                "Server:Microsoft-IIS/7.5\n" +
                "Vary:Accept-Encoding\n" +
                "X-Powered-By:PHP/5.2.8\n" +
                "X-Powered-By:ASP.NET";

        Document doc = new Document(html, Parser.parseBodyFragment(html, ParserMode.STRICT));
        Element responseHeaders = doc.select("http://01pt.com/").first();

        Map<String, List<String>> resHeaders = new HashMap<>();
        for (Element header : responseHeaders.select("header")) {
            String name = header.attr("name");
            String value = header.text();
            if (!resHeaders.containsKey(name)) {
                resHeaders.put(name, new ArrayList<>());
            }
            resHeaders.get(name).add(value);
        }

        assertEquals("PHP/5.2.8 ASP.NET", resHeaders.get("X-Powered-By").get(0));
    }
}
