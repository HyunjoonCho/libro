
public void testVersionNeededToExtract() {
    ZipArchiveOutputStream zip = new ZipArchiveOutputStream(new ByteArrayOutputStream());
    zip.setUseZip64(Zip64Mode.AsNeeded);

    ZipArchiveEntry entry = new ZipArchiveEntry("test.txt");
    entry.setCompressedSize(1024);
    entry.setSize(1024);

    zip.putArchiveEntry(entry);
    zip.closeEntry();

    byte[] buffer = zip.getBytes();

    // Check the local file header
    int localVersionNeeded = zip.getZip64Mode()? Zip64.MIN_VERSION : INITIAL_VERSION;
    assertEquals(localVersionNeeded, getShort(buffer, LOCAL_FILE_HEADER_VERSION_NEEDED_OFFSET));

    // Check the central directory
    int centralVersionNeeded = versionNeededToExtract(ZipMethod.DEFLATED, zip.getUseZip64() && zip.getZip64Mode() == Zip64Mode.AsNeeded);
    assertEquals(centralVersionNeeded, getShort(buffer, CENTRAL_DIRECTORY_VERSION_NEEDED_OFFSET));
}

private int getShort(byte[] buffer, int offset) {
    return (buffer[offset] & 0xFF) << 8 | (buffer[offset + 1] & 0xFF);
}
