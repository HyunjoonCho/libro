public void testBugReport() {
    Object result = someFunction(true);
    assertEquals(true, ((Map<String, Function>) result).get("method1")());
    assertEquals(true, ((Map<String, Function>) result).get("method2"));
}

private Object someFunction(boolean anyExpression) {
    Object fn1, fn2;
    if (anyExpression) {
        fn2 = externalRef;
        fn1 = new Function("content") {
            public Object invoke(Object[] args) {
                return fn2();
            }
        };
    }
    return new HashMap<String, Function>() {{
        { "method1", new Function() {
            public Object invoke() {
                if (fn1!= null) fn1.invoke(null);
                return true;
            }
        } },
        "method2", new Function() {
            public Object invoke() {
                return false;
            }
        }
    }};
}