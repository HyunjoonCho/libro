java
import org.junit.Test;
import org.junit.runner.RunWith;
import org.junit.runners.JUnit4;

import org.apache.commons.jxpath.JXPathContext;
import org.w3c.dom.Document;
import org.w3c.dom.Element;

import java.io.IOException;
import java.io.StringWriter;
import java.io.Writer;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;

import static org.junit.Assert.fail;

@RunWith(JUnit4.class)
public class JXPathTest {

    @Test
    public void testResettingDefaultNamespaceCausesEndlessLoop() throws IOException {
        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
        DocumentBuilder builder = factory.newDocumentBuilder();
        Document document = builder.newDocument();

        Element foo = document.createElement("foo");
        foo.setAttribute("xmlns:b", "bla");
        foo.setAttribute("xmlns", "test111");
        Element bar = document.createElement("b:bar");
        bar.setTextContent("a");
        foo.appendChild(bar);
        Element test = document.createElement("test");
        foo.appendChild(test);

        JXPathContext context = JXPathContext.newContext(document);
        try {
            context.getDotNotation(test);
            fail("Expected endless loop");
        } catch (StackOverflowError e) {
            // Expected
        }
    }
}
