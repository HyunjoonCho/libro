java
import org.apache.commons.jxpath.JXPathContext;
import org.apache.commons.jxpath.JXPathException;
import org.junit.Test;

import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.ParserConfigurationException;
import java.io.ByteArrayInputStream;
import java.io.IOException;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertThrows;

public class JXPathTest {

    @Test
    public void testResettingDefaultNamespaceCausesEndlessLoop() throws ParserConfigurationException, IOException {
        String xml = "<root><b:foo xmlns:b=\"bla\" xmlns=\"test111\"><b:bar>a</b:bar><test xmlns=\"\"></test></b:foo></root>";
        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
        DocumentBuilder builder = factory.newDocumentBuilder();
        org.w3c.dom.Document doc = builder.parse(new ByteArrayInputStream(xml.getBytes()));
        JXPathContext context = JXPathContext.newContext(doc);
        Object testNode = context.selectNode("root/b:foo/test");
        assertEquals("test", testNode.getClass().getSimpleName());
        // This should throw an exception due to the endless loop
        assertThrows(JXPathException.class, () -> context.getExpression("//test").execute(testNode));
    }
}
