java
import org.apache.commons.jxpath.JXPathContext;
import org.junit.Test;
import org.w3c.dom.Document;
import org.w3c.dom.Element;

import java.util.HashMap;
import java.util.Map;

import static org.junit.Assert.assertSame;
import static org.junit.Assert.assertTrue;
import static org.junit.Assert.fail;

public class JXPathTest {

    @Test
    public void testResettingDefaultNamespaceCausesEndlessLoop() {
        Map<String, String> namespaceMap = new HashMap<>();
        namespaceMap.put("bla", "http://bla");
        namespaceMap.put("", "test111");

        Document document = createTestDocument(namespaceMap);
        JXPathContext context = JXPathContext.newContext(document);
        Element testNode = (Element) context.getContextNode("//test");

        try {
            testNode.asPath();
            fail("Expected an endless loop");
        } catch (StackOverflowError e) {
            // expected
        }
    }

    private Document createTestDocument(Map<String, String> namespaceMap) {
        Document document = new Document();
        Element fooElement = document.createElement("foo");
        fooElement.setAttribute("xmlns:b", namespaceMap.get("bla"));
        fooElement.setAttribute("xmlns", namespaceMap.get(""));

        Element barElement = document.createElement("b:bar");
        barElement.setTextContent("a");
        fooElement.appendChild(barElement);

        Element testElement = document.createElement("test");
        fooElement.appendChild(testElement);

        document.appendChild(fooElement);
        return document;
    }
}
