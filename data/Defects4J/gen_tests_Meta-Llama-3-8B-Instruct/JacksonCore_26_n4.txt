
import com.fasterxml.jackson.core.JsonFactory;
import com.fasterxml.jackson.core.JsonParser;
import com.fasterxml.jackson.core.JsonToken;
import com.fasterxml.jackson.core.async.ByteArrayFeeder;
import org.junit.Test;

import java.nio.charset.StandardCharsets;

import static org.junit.Assert.assertEquals;

public class FeedingOffsetTest {

    @Test
    public void testInputOffsetAffectsLocations() throws Exception {
        JsonFactory jsonFactory = new JsonFactory();
        JsonParser parser = jsonFactory.createNonBlockingByteArrayParser();
        ByteArrayFeeder feeder = (ByteArrayFeeder) parser.getNonBlockingInputFeeder();

        byte[] input = "[[[".getBytes(StandardCharsets.UTF_8);

        feeder.feedInput(input, 7, 3); // input offset 7
        assertEquals(JsonToken.START_ARRAY, parser.nextToken());
        assertEquals(4, parser.getCurrentLocation().getByteOffset()); // expected 1, but got 7
        assertEquals(4, parser.getTokenLocation().getByteOffset()); // expected 1, but got 7

        feeder.feedInput(input, 0, 1);
        assertEquals(JsonToken.START_ARRAY, parser.nextToken());
        assertEquals(5, parser.getCurrentLocation().getByteOffset()); // expected 2, but got 8
        assertEquals(5, parser.getTokenLocation().getByteOffset()); // expected 2, but got 8
    }
}
