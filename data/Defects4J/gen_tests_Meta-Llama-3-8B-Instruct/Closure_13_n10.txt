public void testBooleanReplacement() {
    Function f = new Function() {
        boolean fn1;
        boolean fn2;

        if (true) {
            fn2 = true;
            fn1 = new Function() {
                return fn2;
            };
        }

        return new Object() {
            public boolean method1() {
                fn1 && fn1();
                return true;
            }

            public boolean method2() {
                return false;
            }
        };
    };

    Object obj = f.call();
    Method m1 = obj.getClass().getMethod("method1");
    Method m2 = obj.getClass().getMethod("method2");
    try {
        m1.invoke(obj);
        fail("Expected method1 to return false");
    } catch (InvocationTargetException e) {
        // expected
    }
    assertEquals(false, m2.invoke(obj));
}