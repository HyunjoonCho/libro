
import org.junit.Test;
import org.junit.runner.RunWith;
import org.junit.runners.JUnit4;

import com.google.javascript.jscomp.CompilationLevel;
import com.google.javascript.jscomp.Compiler;
import com.google.javascript.jscomp.CompilerOptions;
import com.google.javascript.jscomp.JSError;

import java.io.ByteArrayOutputStream;
import java.io.PrintStream;

@RunWith(JUnit4.class)
public class JscDeterministicTestTest {
    @Test
    public void testJscDeterministicTest() {
        Compiler compiler = new Compiler();
        CompilerOptions options = new CompilerOptions();
        options.setCompilationLevel(CompilationLevel ADVANCED_OPTIMIZATIONS);
        ByteArrayOutputStream bos = new ByteArrayOutputStream();
        PrintStream originalOut = System.out;
        System.setOut(new PrintStream(bos));
        try {
            compiler.compile("var t = null;\r\n" +
                    "window.test = function()\r\n" +
                    "{\r\n" +
                    "  if (t!= null)\r\n" +
                    "  {\r\n" +
                    "    t = null;\r\n" +
                    "  }\r\n" +
                    "\r\n" +
                    "  t = 1;\r\n" +
                    "};", options);
        } finally {
            System.setOut(originalOut);
        }
        String output = bos.toString();
        JSError error = JSError.fromOutput(output);
        assertNotNull(error);
        assertEquals("JSC_DETERMINISTIC_TEST: condition always evaluates to false", error.getMessage());
    }
}
