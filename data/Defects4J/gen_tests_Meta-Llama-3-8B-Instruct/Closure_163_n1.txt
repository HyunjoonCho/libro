java
import com.google.javascript.jscomp.Compiler;
import com.google.javascript.jscomp.CompilerOptions;
import com.google.javascript.jscomp.Module;
import com.google.javascript.jscomp.ModuleSet;
import com.google.javascript.jscomp.SourceFile;
import com.google.javascript.jscomp.CompilerException;

import org.junit.Test;
import static org.junit.Assert.fail;

public class VarCheckCrashWhenUsingModulesTest {

    @Test
    public void testVarCheckCrashWhenUsingModules() {
        Compiler compiler = new Compiler();
        CompilerOptions options = new CompilerOptions();
        options.setModuleMode(true);
        options.setModuleOutputPathPrefix("mod_");
        options.setModulePrefix("jquery:1");
        options.setModulePrefix("core:1:jquery");

        ModuleSet moduleSet = new ModuleSet();
        moduleSet.addModule(new Module("jquery", "jquery.js"));
        moduleSet.addModule(new Module("core", "core.js"));
        moduleSet.addExternal(new SourceFile("qunit_externs.js"));

        try {
            compiler.compileModules(moduleSet, options);
            fail("Expected a CompilerException");
        } catch (CompilerException e) {
            assertEquals("Unexpected variable jQuery$$2", e.getMessage());
        }
    }
}
