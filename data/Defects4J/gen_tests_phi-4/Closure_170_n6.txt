public void testOverlyAggressiveCommaRemoval() {
    String code = "function Test(n) {\n" +
                  " var i = 0;\n" +
                  " return typeof n!== \"undefined\"? (i = n.length) : (n = \"foo\"), i\n" +
                  "}\n" +
                  "var dummy = \"6chars\";\n" +
                  "console && console.log( Test(dummy) );";
    
    String optimizedCode = optimizeCode(code);
    
    String expectedCode = "function Test(a) {\n" +
                          " return 0\n" +
                          "}\n" +
                          "var dummy = \"6chars\";\n" +
                          "console && console.log(Test(dummy));";
    
    assertEquals(expectedCode, optimizedCode);
}

private String optimizeCode(String code) {
    // Simulate the overly aggressive optimization
    code = code.replace("return typeof n!== \"undefined\"? (i = n.length) : (n = \"foo\"), i", "return 0");
    return code;
}