public void testVarCheckCrashWithModules() {
    Compiler compiler = new Compiler();
    CompilerOptions options = new CompilerOptions();
    options.setCompilationLevel(CompilationLevel.ADVANCED_OPTIMIZATIONS);
    options.formattingOutputForPreTTYPrint();
    options.setDebug(true);
    options.addModule("jquery", "1");
    options.addModule("core", "1:jquery");
    options.setModuleOutputPathPrefix("mod_");
    
    String jqueryJs = "var jQuery$$2 = function (selector) { return { length: 1 }; };";
    String coreJs = "equal(jQuery(\"<div/>\").length, 1, \"Make sure whitespace is trimmed.\");";
    String externsJs = "";

    JSSourceFile jqueryFile = SourceFile.fromCode("jquery.js", jqueryJs);
    JSSourceFile coreFile = SourceFile.fromCode("core.js", coreJs);
    JSSourceFile externsFile = SourceFile.fromCode("qunit_externs.js", externsJs);

    compiler.addSourceFile(jqueryFile);
    compiler.addSourceFile(coreFile);
    compiler.addExterns(externsFile);

    try {
        compiler.compile();
        fail("Expected