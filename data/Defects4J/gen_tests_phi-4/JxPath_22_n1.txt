public void testResettingDefaultNamespaceCausesLoop() throws Exception {
    DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
    factory.setNamespaceAware(true);
    DocumentBuilder builder = factory.newDocumentBuilder();
    Document doc = builder.newDocument();

    String nsB = "bla";
    String nsDefault = "test111";

    Element foo = doc.createElementNS(nsB, "b:foo");
    foo.setAttributeNS("http://www.w3.org/2000/xmlns/", "xmlns:b", nsB);
    foo.setAttributeNS("http://www.w3.org/2000/xmlns/", "xmlns", nsDefault);

    Element bar = doc.createElementNS(nsB, "b:bar");
    bar.setTextContent("a");
    foo.appendChild(bar);

    Element test = doc.createElement("test");
    foo.appendChild(test);

    doc.appendChild(foo);

    XPathFactory xPathFactory = XPathFactory.newInstance();
    XPath xpath = xPathFactory.newXPath();
    xpath.setNamespaceContext(new SimpleNamespaceContext() {
        @Override
        public String getNamespaceURI(String prefix) {
            if ("b".equals(prefix)) return nsB;
            if (prefix == null) return nsDefault;
            return null;
        }
    });

    XPathExpression