public void testResettingDefaultNamespaceCausesEndlessLoop() {
    DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
    factory.setNamespaceAware(true);
    DocumentBuilder builder = factory.newDocumentBuilder();
    Document doc = builder.newDocument();

    Element root = doc.createElementNS("", "b:foo");
    root.setAttributeNS("http://www.w3.org/2000/xmlns/", "xmlns:b", "bla");
    root.setAttributeNS("http://www.w3.org/2000/xmlns/", "xmlns", "test111");
    doc.appendChild(root);

    Element bar = doc.createElementNS("bla", "b:bar");
    bar.setTextContent("a");
    root.appendChild(bar);

    Element test = doc.createElementNS("", "test");
    root.appendChild(test);

    XPathFactory xPathFactory = XPathFactory.newInstance();
    XPath xpath = xPathFactory.newXPath();
    xpath.setNamespaceContext(new NamespaceContext() {
        @Override
        public String getNamespaceURI(String prefix) {
            if ("b".equals(prefix)) {
                return "bla";
            } else if (prefix == null) {
                return "test111";
            }
            return null;
        }

        @Override
        public String getPrefix(String namespaceURI) {