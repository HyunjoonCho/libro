public void testProcessCommonJSModulesModuleExportsFailure() {
    String echoJs = "define(function() { return { echo: function(val) { window.console.log(val); } }; });";
    String echoMainJs = "var echo = require('echo'); echo.echo('hello world');";

    Compiler compiler = new Compiler();
    compiler.setOptions("--formatting=PRETTY_PRINT --jscomp_error=checkTypes --compilation_level=SIMPLE_OPTIMIZATIONS --transform_amd_modules --process_common_js_modules");
    compiler.addFile("echo.js", echoJs);
    compiler.addFile("echo-main.js", echoMainJs);
    compiler.setEntryModule("echo-main.js");

    try {
        compiler.compile();
        fail("Should have thrown an error about'module$exports' not being defined");
    } catch (CompilationError e) {
        assertTrue(e.getMessage().contains("Property module$exports never defined on module$echo_main"));
    }
}