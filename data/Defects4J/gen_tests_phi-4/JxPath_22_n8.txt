public void testResettingDefaultNamespaceCausesEndlessLoop() throws Exception {
    DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
    factory.setNamespaceAware(true);
    DocumentBuilder builder = factory.newDocumentBuilder();
    Document doc = builder.newDocument();

    Element foo = doc.createElementNS("bla", "b:foo");
    foo.setAttributeNS("http://www.w3.org/2000/xmlns/", "xmlns", "test111");
    Element bar = doc.createElementNS("bla", "b:bar");
    bar.setTextContent("a");
    foo.appendChild(bar);

    Element test = doc.createElement("test");
    test.setAttributeNS("http://www.w3.org/2000/xmlns/", "xmlns", "");
    foo.appendChild(test);

    doc.appendChild(foo);

    XPathFactory xPathFactory = XPathFactory.newInstance();
    XPath xpath = xPathFactory.newXPath();
    XPathExpression expr = xpath.compile("//test");

    NodeList nodes = (NodeList) expr.evaluate(doc, XPathConstants.NODESET);
    assertNotNull(nodes);
    assertEquals(1, nodes.getLength());

    Object result = expr.evaluate(doc, XPathConstants.STRING);
    assertEquals("/bla:foo/test", result.toString());
}