import com.fasterxml.jackson.annotation.JsonIdentityInfo;
import com.fasterxml.jackson.annotation.ObjectIdGenerators;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.junit.jupiter.api.Test;

import static org.junit.jupiter.api.Assertions.assertEquals;

public class JsonIdentityInfoTest {

    @JsonIdentityInfo(generator = ObjectIdGenerators.PropertyGenerator.class, property = "id")
    public static class A {
        public int id;
        public B b;

        @JsonCreator
        public A(int id, B b) {
            this.id = id;
            this.b = b;
        }
    }

    @JsonIdentityInfo(generator = ObjectIdGenerators.PropertyGenerator.class, property = "id")
    public static class B {
        public int id;
        public A a;

        @JsonCreator
        public B(int id, A a) {
            this.id = id;
            this.a = a;
        }
    }

    @Test
    public void testJsonIdentityInfoDeserialization() throws Exception {
        String json = "{\"id\":1,\"b\":{\"id\":2,\"a\":{\"$ref\":\"1\"}}}";

        ObjectMapper mapper = new ObjectMapper();
        A obj = mapper.readValue(json, A.class);

        assertEquals(1, obj.id);
        assertEquals(2, obj