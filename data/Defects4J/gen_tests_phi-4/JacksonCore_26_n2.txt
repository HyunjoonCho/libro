import com.fasterxml.jackson.core.JsonFactory;
import com.fasterxml.jackson.core.JsonParser;
import com.fasterxml.jackson.core.JsonToken;
import com.fasterxml.jackson.core.async.ByteArrayFeeder;
import org.junit.Test;

import static java.nio.charset.StandardCharsets.UTF_8;
import static org.junit.Assert.assertEquals;

public class FeedingOffsetTest {

  @Test
  public void testInputOffsetShouldNotAffectLocations() throws Exception {
    JsonFactory jsonFactory = new JsonFactory();
    JsonParser parser = jsonFactory.createNonBlockingByteArrayParser();
    ByteArrayFeeder feeder = (ByteArrayFeeder) parser.getNonBlockingInputFeeder();

    byte[] input = "[[[[7".getBytes(UTF_8);

    feeder.feedInput(input, 1, 4); // Offset 1, length 4
    assertEquals(JsonToken.START_ARRAY, parser.nextToken());
    assertEquals(1, parser.getCurrentLocation().getByteOffset()); // Expected: 1, Actual: 5
    assertEquals(1, parser.getTokenLocation().getByteOffset());   // Expected: 1, Actual: 5

    feeder.feedInput(input, 0, 1); // Offset 0, length 1
    assertEquals(JsonToken.START_ARRAY, parser.nextToken());