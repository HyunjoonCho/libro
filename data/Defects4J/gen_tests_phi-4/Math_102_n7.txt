public void testChiSquareWithRescaling() {
    long[] observed1 = { 500, 623, 72, 70, 31 };
    double[] expected1 = { 485, 541, 82, 61, 37 };

    ChiSquareTestImpl testStatistic = new ChiSquareTestImpl();

    double sumExpected = 0;
    double sumObserved = 0;
    for (int i = 0; i < expected1.length; i++) {
        sumExpected += expected1[i];
        sumObserved += observed1[i];
    }

    double scale = sumObserved / sumExpected;
    double[] scaledExpected = new double[expected1.length];
    for (int i = 0; i < expected1.length; i++) {
        scaledExpected[i] = expected1[i] * scale;
    }

    double chiSquareValue = testStatistic.chiSquare(scaledExpected, observed1);

    assertEquals("chi-square test statistic with rescaling", 9.0233, chiSquareValue, 1E-4);
}

This test checks that the chi-square calculation correctly rescales the expected frequencies to match the total of the observed frequencies before calculating the chi