public void testProcessCommonJSModules() throws IOException {
    // Define the echo module
    String echoJs = "define(function() { return { echo: function(val) { console.log(val); } }; });";

    // Define the echo-main entry point that does not define any new modules
    String echoMainJs = "var echo = require('echo'); echo.echo('hello world');";

    // Compile with ProcessCommonJSModules
    Compilation compilation = JavaCompiler.compile(
        "--formatting=PRETTY_PRINT",
        "--jscomp_error=checkTypes",
        "--compilation_level=SIMPLE_OPTIMIZATIONS",
        "--transform_amd_modules",
        "--process_common_js_modules",
        "--js", "echo.js",
        "--js", "echo-main.js",
        "--common_js_entry_module=echo-main.js"
    );

    // Verify that the compilation fails
    assertEquals(1, compilation.getErrors().size());
    String errorMessage = compilation.getErrors().get(0).getMessage();
    assertTrue(errorMessage.contains("Property module$exports never defined on module$echo_main"));
}