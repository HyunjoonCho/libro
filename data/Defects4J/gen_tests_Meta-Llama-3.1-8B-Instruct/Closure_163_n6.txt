java
public void testVarCheckCrashWhenUsingModules() throws Exception {
    String coreJs = "function jQuery(element) { return { length: 1 }; }";
    String jqueryJs = "function equal(a, b, message) { if (a!== b) throw 'Assertion failed:'+ message; }";
    String qunitExternsJs = "function jQuery(element) { return { length: 1 }; }";

    Compiler compiler = new Compiler();
    compiler.addSource("core.js", coreJs);
    compiler.addSource("jquery.js", jqueryJs);
    compiler.addSource("qunit_externs.js", qunitExternsJs);

    compiler.setModule("jquery", "jquery");
    compiler.setModule("core", "core:jquery");
    compiler.setModuleOutputPathPrefix("mod");

    try {
        compiler.compile();
        fail("Expected VarCheck to crash");
    } catch (RuntimeException e) {
        assertTrue(e.getMessage().contains("INTERNAL COMPILER ERROR"));
        assertTrue(e.getMessage().contains("Unexpected variable jQuery$$2"));
    }
}
