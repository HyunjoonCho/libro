java
public void testEscapeModeXhtmlFallback() throws Exception {
    String input = "<html><body>before&nbsp;after</body></html>";
    Document doc = Jsoup.parse(input);
    doc.outputSettings().escapeMode(EscapeMode.xhtml);

    // In JSoup 1.7.2, this would print "beforeÂ after" (with a non-breaking space)
    // In JSoup 1.8.1, this prints "before?after" (with a question mark)

    // Test that the old behavior is preserved
    assertEquals("&nbsp;", doc.html().replace(" ", ""));

    // Test that the new behavior is also preserved
    doc.outputSettings().escapeMode(EscapeMode.xhtml);
    doc.html().replace(" ", "");
    assertEquals("before?after", doc.html());
}
