public void testProcessCommonJSModules() throws Exception {
    String echoJs = "define(function() { return { echo: function(val) { window.console.log(val); } }; })";
    String echoMainJs = "var echo = require('echo'); echo.echo('hello world');";
    String output = new ProcessCommonJSModules().process(compile(echoJs, echoMainJs));
    assertTrue(output.contains("ERROR - Property module$exports never defined on module$echo_main"));
}

private String compile(String... files) throws Exception {
    // Simulate compilation with JavaCompiler
    // For simplicity, assume a basic compiler implementation
    String compilationCommand = "java -jar build/compiler.jar --formatting=PRETTY_PRINT --jscomp_error=checkTypes --compilation_level=SIMPLE_OPTIMIZATIONS --transform_amd_modules --process_common_js_modules --js=" + String.join(" --js=", files);
    Process process = Runtime.getRuntime().exec(compilationCommand);
    return new String(process.getInputStream().readAllBytes());
}