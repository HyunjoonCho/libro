public void testNodeSetReturnedByExtensionFunction() throws Exception {
    JXPathContext context = JXPathContext.newInstance(new Document(new Element("root")));
    NodeSet nodeSet = new BasicNodeSet();
    nodeSet.add(new NodePointer(new Element("child1")));
    nodeSet.add(new NodePointer(new Element("child2")));
    context.setContextNodePointer(new NodePointer(new Element("parent")));
    context.getContext().getFunctions().registerFunction("ems:observations", new Function() {
        @Override
        public Object invoke(ExpressionContext ec) throws Exception {
            return nodeSet;
        }
    });
    NodeList nodes = (NodeList) context.selectNodes("ems:observations()");
    assertEquals(2, nodes.getLength());
}