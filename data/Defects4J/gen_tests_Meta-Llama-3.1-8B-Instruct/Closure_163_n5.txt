java
import com.google.javascript.jscomp.Compiler;
import com.google.javascript.jscomp.CompilerOptions;
import com.google.javascript.jscomp.SourceFile;

public class VarCheckCrashWhenUsingModulesTest {
    public void testVarCheckCrashWhenUsingModules() throws Exception {
        CompilerOptions options = new CompilerOptions();
        options.setModuleMode(CompilerOptions.ModuleMode.NO_MODULE);
        options.setModuleResolutionKind(CompilerOptions.ModuleResolutionKind.STRICT);
        options.setModuleResolutionKind(CompilerOptions.ModuleResolutionKind.STRICT);

        SourceFile jqueryModule = new SourceFile("jquery.js", "goog.provide('jquery');\n" +
                "goog.require('core');\n" +
                "function jQuery() {}");

        SourceFile coreModule = new SourceFile("core.js", "goog.provide('core');\n" +
                "function core() {}");

        Compiler compiler = new Compiler();
        compiler.compile(new SourceFile[] { jqueryModule, coreModule }, options);

        // This should crash the compiler
        compiler.compile(new SourceFile[] { new SourceFile("test.js", "goog.require('jquery');") }, options);
    }
}
