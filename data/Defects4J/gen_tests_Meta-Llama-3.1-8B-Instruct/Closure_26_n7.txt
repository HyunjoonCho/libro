public void testProcessCommonJSModules() {
    String source1 = "define(function() { return { echo: function(val) { window.console.log(val); } }; });";
    String source2 = "var echo = require('echo'); echo.echo('hello world');";

    Compilation compilation = Compilation.compile(
            new StringSource("echo.js", source1),
            new StringSource("echo-main.js", source2));

    List<Error> errors = compilation.getErrors();
    assertEquals(1, errors.size());
    String message = errors.get(0).getMessage();
    assertTrue(message.contains("Property module$exports never defined on module$echo_main"));
}