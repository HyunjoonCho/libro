public void testAMDModuleInSubdirectory() throws Exception {
    File dir = new File("target");
    dir.mkdirs();
    File libDir = new File(dir, "lib");
    libDir.mkdirs();
    File fooJs = new File(libDir, "Foo.js");
    File barJs = new File(dir, "Bar.js");

    // Write AMD module Foo.js
    writeJsFile(fooJs, "define('module$lib$Foo', function() { return 'Foo'; });");

    // Write AMD module Bar.js
    writeJsFile(barJs, "define('module$Bar', ['module$lib$Foo'], function(Foo) { return 'Bar'; });");

    // Compile Bar.js with --transform_amd_modules
    ProcessBuilder processBuilder = new ProcessBuilder("java", "-jar", "compiler.jar",
            "--transform_amd_modules", "--process_common_js_modules",
            "--common_js_entry_module=Bar.js", "--compilation_level=ADVANCED_OPTIMIZATIONS",
            "--js_output_file=out.js", "--js=Bar.js", "--js=lib/Foo.js");
    processBuilder.directory(dir);
    Process process = processBuilder.start();
    int exitCode = process.waitFor();