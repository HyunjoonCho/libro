public void testScopeCrash() throws Exception {
    Compiler compiler = new Compiler();
    SourceFile script = compiler.createSourceFile("test.js");
    script.print("var goog = {};");
    script.print("goog.scope;");
    script.print("var ns = {};");
    script.print("ns.sub = {};");
    script.print("/** @constructor */");
    script.print("ns.sub.C = function() {};");
    script.print("goog.scope(function() {");
    script.print(" var sub = ns.sub;");
    script.print(" /** @type {sub.C} */");
    script.print(" var x = null;");
    script.print("});");

    compiler.compile();
    try {
        compiler.process();
        fail("Expected IllegalStateException");
    } catch (IllegalStateException e) {
        // Expected exception
    }
}