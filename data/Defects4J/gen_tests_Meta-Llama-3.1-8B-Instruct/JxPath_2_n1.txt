java
public void testNodeSetReturnedByExtensionFunction() throws Exception {
    // Create a sample XML document
    DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
    DocumentBuilder builder = factory.newDocumentBuilder();
    Document document = builder.newDocument();
    Element root = document.createElement("root");
    document.appendChild(root);
    Element child = document.createElement("child");
    root.appendChild(child);
    Element grandchild = document.createElement("grandchild");
    child.appendChild(grandchild);
    document.getDocumentElement().normalize();

    // Create a JXPathContext
    JXPathContext context = JXPathContext.newInstance(document);

    // Create an extension function that returns a NodeSet
    ExtensionFunction function = new ExtensionFunction() {
        @Override
        public Object evaluate(Object[] context) {
            List<NodePointer> ptrs = new ArrayList<>();
            ptrs.add(context[0].getNode().getNodePointer());
            ptrs.add(context[0].getNode().getNodePointer().getFirstChild().getNodePointer());
            BasicNodeSet result = new BasicNodeSet();
            for (NodePointer ptr : ptrs) {
                result.add(ptr);
            }
            return result;
        }
    };

    // Register the extension function
    context.getFunctions().declarePrefix("ems",