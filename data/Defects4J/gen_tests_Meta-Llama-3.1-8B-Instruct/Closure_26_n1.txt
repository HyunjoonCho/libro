public void testProcessCommonJSModules() throws Exception {
    // Create a temporary directory
    File tempDir = new File(System.getProperty("java.io.tmpdir"), "testProcessCommonJSModules");
    tempDir.mkdir();

    // Create echo.js
    File echoJs = new File(tempDir, "echo.js");
    PrintWriter writer = new PrintWriter(echoJs);
    writer.println("define(function() { return { echo: function(val) { console.log(val); }});");
    writer.close();

    // Create echo-main.js
    File echoMainJs = new File(tempDir, "echo-main.js");
    writer = new PrintWriter(echoMainJs);
    writer.println("var echo = require('echo'); echo.echo('hello world');");
    writer.close();

    // Run the compiler
    ProcessBuilder pb = new ProcessBuilder("java", "-jar", "compiler.jar", "--formatting=PRETTY_PRINT", "--jscomp_error=checkTypes",
            "--compilation_level=SIMPLE_OPTIMIZATIONS", "--transform_amd_modules", "--process_common_js_modules",
            "--js=" + echoJs.getAbsolutePath(), "--js=" + echoMainJs.getAbsolutePath(), "--common_js_entry_module=" + echoMainJs.getAbsolutePath());
    Process process