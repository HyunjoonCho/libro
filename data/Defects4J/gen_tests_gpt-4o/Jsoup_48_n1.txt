
import org.jsoup.Connection;
import org.jsoup.Jsoup;
import org.jsoup.helper.HttpConnection;
import org.junit.Test;
import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import static org.junit.Assert.assertEquals;

public class DuplicateHeaderTest {

    @Test
    public void testDuplicateHeaders() throws IOException {
        // Simulate response headers
        Map<String, List<String>> responseHeaders = new HashMap<>();
        responseHeaders.put("X-Powered-By", List.of("PHP/5.2.8", "ASP.NET"));

        // Create a connection with a mock response
        Connection.Response mockResponse = new HttpConnection.Response(null);
        simulateResponseHeaders(mockResponse, responseHeaders);

        // Check if the headers are correctly combined
        String headerValue = mockResponse.header("X-Powered-By");
        assertEquals("PHP/5.2.8 ASP.NET", headerValue);
    }

    private void simulateResponseHeaders(Connection.Response response, Map<String, List<String>> resHeaders) {
        for (Map.Entry<String, List<String>> entry : resHeaders.entrySet()) {
            String name = entry.getKey();
            if (name == null) continue;

            List<String> values = entry.getValue();
            if (!values.isEmpty()) {
                StringBuilder val = new StringBuilder();
                for (String str : values) {
                    val.append(str).append(" ");
                }
                // Trim the trailing space
                response.header(name, val.toString().trim());
            }
        }
    }
}
