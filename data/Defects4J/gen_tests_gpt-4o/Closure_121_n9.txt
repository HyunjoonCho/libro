
import org.mozilla.javascript.Context;
import org.mozilla.javascript.Function;
import org.mozilla.javascript.Scriptable;
import static org.junit.Assert.fail;
import org.junit.Test;

public class OptimizationBugTest {

    @Test
    public void testOverzealousOptimization() {
        String originalCode = "var uid;" +
                "function reset() {" +
                "    uid = Math.random();" +
                "}" +
                "function doStuff() {" +
                "    reset();" +
                "    var _uid = uid;" +
                "    if (uid < 0.5) {" +
                "        doStuff();" +
                "    }" +
                "    if (_uid !== uid) {" +
                "        throw 'reset() was called';" +
                "    }" +
                "}" +
                "doStuff();";

        try {
            Context context = Context.enter();
            Scriptable scope = context.initStandardObjects();
            context.evaluateString(scope, originalCode, "testScript", 1, null);
        } catch (Exception e) {
            if (e.getMessage().equals("reset() was called")) {
                fail("Optimization bug: '_uid' was optimized away.");
            } else {
                // Handle other possible exceptions
                fail("Unexpected exception: " + e.getMessage());
            }
        } finally {
            Context.exit();
        }
    }
}
