
import com.google.gson.Gson;
import com.google.gson.JsonParseException;
import org.junit.Test;

import java.util.concurrent.locks.Lock;

import static org.junit.Assert.assertThrows;

public class GsonJniErrorTest {

    class FeedItem {
        String feedItemChannel;
        EstimatedData estimatedData;
        boolean isDeleted;
        int isDeletingEventually;
        Lock mutex;  // This field causes problems in Gson deserialization
        Object operationSetQueue;
        Object saveEvent;        
        State state;
        TaskQueue taskQueue;
    }

    class EstimatedData {
        String feedTopic;
        int feedComments;
        String createdBy;
        String feedQuestion;
        String feedDesc;
    }

    class State {
        String className;
        long createdAt;
        boolean isComplete;
        String objectId;
        ServerData serverData;
        long updatedAt;
    }

    class ServerData {
        String feedTopic;
        String createdBy;
        int feedComments;
        String feedQuestion;
        String feedDesc;
    }

    class TaskQueue {
        Lock lock;
    }

    @Test
    public void testGsonJniError() {
        String json = "{"
                + "\"feedItemChannel\":\"mdldsrgXN1\","
                + "\"estimatedData\":{"
                + " \"feedTopic\":\"Testing\","
                + " \"feedComments\":2,"
                + " \"createdBy\":\"KXTQtpfBSW\","
                + " \"feedQuestion\":\"Test Question \","
                + " \"feedDesc\":\"Test \"},"
                + "\"isDeleted\":false,"
                + "\"isDeletingEventually\":0,"
                + "\"mutex\":{},"
                + "\"operationSetQueue\":{},"
                + "\"saveEvent\":{},"
                + "\"state\":{"
                + " \"className\":\"FeedItem\","
                + " \"createdAt\":1458798818385,"
                + " \"isComplete\":true,"
                + " \"objectId\":\"mdldsrgXN1\","
                + " \"serverData\":{"
                + " \"feedTopic\":\"TestTopic\","
                + " \"createdBy\":\"KXTQtpfBSW\","
                + " \"feedComments\":2,"
                + " \"feedQuestion\":\"Test Question \","
                + " \"feedDesc\":\"Test \"},"
                + " \"updatedAt\":1458803553636"
                + "},"
                + "\"taskQueue\":{"
                + " \"lock\":{}"
                + "}"
                + "}";

        Gson gson = new Gson();
        
        assertThrows(JsonParseException.class, () -> {
            gson.fromJson(json, FeedItem.class);
        });
    }
}
