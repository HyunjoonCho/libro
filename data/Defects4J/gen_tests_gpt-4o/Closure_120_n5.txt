
import javax.script.ScriptEngine;
import javax.script.ScriptEngineManager;
import javax.script.ScriptException;
import org.junit.Test;
import static org.junit.Assert.fail;

public class JSMinificationTest {

    @Test
    public void testOverzealousOptimization() {
        ScriptEngineManager manager = new ScriptEngineManager();
        ScriptEngine engine = manager.getEngineByName("nashorn");

        String jsScript =
            "var uid;\n" +
            "function reset() {\n" +
            "    uid = Math.random();\n" +
            "}\n" +
            "function doStuff() {\n" +
            "    reset();\n" +
            "    var _uid = uid;\n" +
            "    if (uid < 0.5) {\n" +
            "        doStuff();\n" +
            "    }\n" +
            "    if (_uid !== uid) {\n" +
            "        throw 'reset() was called';\n" +
            "    }\n" +
            "}\n" +
            "try {\n" +
            "    doStuff();\n" +
            "} catch (e) {\n" +
            "    throw new Error('Test Failed: ' + e);\n" +
            "}";

        try {
            engine.eval(jsScript);
        } catch (ScriptException e) {
            fail(e.getMessage());
        }
    }
}
