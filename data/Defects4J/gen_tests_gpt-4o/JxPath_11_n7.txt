
import org.jaxen.dom.DocumentNav;
import org.jaxen.dom.DOMXPath;
import org.junit.Before;
import org.junit.Test;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.xml.sax.InputSource;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import java.io.StringReader;

import static org.junit.Assert.fail;

public class NamespaceHandlingTest {

    private DocumentBuilder documentBuilder;

    @Before
    public void setUp() throws Exception {
        DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
        dbf.setNamespaceAware(true);
        this.documentBuilder = dbf.newDocumentBuilder();
    }

    @Test
    public void testUnhandledNamespaceInAttributes() {
        try {
            String xmlContent =
                    "<ElementA xmlns:A=\"http://example.com/A\" A:myAttr=\"Mytype\">" +
                        "<B:ElementB xmlns:B=\"http://example.com/B\">MY VALUE</B:ElementB>" +
                    "</ElementA>";

            Document document = documentBuilder.parse(new InputSource(new StringReader(xmlContent)));

            // Simulate the context where the bug occurs
            Node rootElement = document.getDocumentElement();

            // Attempt to work with an attribute that uses a namespace
            DOMXPath xpath = new DOMXPath("/ElementA/@A:myAttr");
            xpath.addNamespace("A", "http://example.com/A");

            xpath.selectSingleNode(DocumentNav.createNavigator(document));

            // If no exception occurs, the test will be non-passing as we expect the bug.
            fail("Expected exception due to unhandled namespace in attribute");
        } catch (Exception e) {
            // Check the exception message to ensure it's related to the undefined namespace
            if (!e.getMessage().contains("unknown namespace prefix")) {
                fail("Unexpected exception: " + e.getMessage());
            }
            // Exception is as expected, thus the test reproduces the issue.
        }
    }
}
