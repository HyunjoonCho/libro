
import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.nio.charset.StandardCharsets;

import org.apache.commons.compress.archivers.tar.TarArchiveEntry;
import org.apache.commons.compress.archivers.tar.TarArchiveInputStream;
import org.junit.Test;

import static org.junit.Assert.assertEquals;

public class TarArchiveInputStreamTest {

    @Test
    public void testLargeUIDInPaxHeader() throws IOException {
        // Simulated PAX header for a tar entry with a large UID
        String paxHeader = "30 uid=4294967294\n30 path=somefile.txt\n";
        String header = "somefile.txt\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
                      + "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
                      + "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
                      + "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
                      + "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
                      + "0000644\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
                      + "00000010344\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00";
        String data = header + paxHeader;

        try (ByteArrayInputStream bais = new ByteArrayInputStream(data.getBytes(StandardCharsets.UTF_8));
             TarArchiveInputStream tais = new TarArchiveInputStream(bais)) {

            // Reading the first entry, which should process the PAX headers
            TarArchiveEntry entry = tais.getNextTarEntry();

            // Assert expected UID
            assertEquals(4294967294L, entry.getLongUserId());
        }
    }
}
