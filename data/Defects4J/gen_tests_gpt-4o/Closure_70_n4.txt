
import org.junit.Test;
import static org.junit.Assert.assertTrue;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.io.FileWriter;
import java.io.File;
import java.io.IOException;

public class ClosureCompilerTest {

    private static final String JS_CODE = 
        "/*global window*/\n" +
        "/*jslint sub: true*/\n" +
        "/**\n" +
        " * @constructor\n" +
        " * @param {!Element} element\n" +
        " */\n" +
        "function Example(element) {\n" +
        "  /**\n" +
        "   * @param {!string} ns\n" +
        "   * @param {!string} name\n" +
        "   * @return {undefined}\n" +
        "   */\n" +
        "  this.appendElement = function appendElement(ns, name) {\n" +
        "    var e = element.ownerDocument.createElementNS(ns, name);\n" +
        "    element.appendChild(e);\n" +
        "  };\n" +
        "}\n" +
        "window[\"Example\"] = Example;";

    @Test
    public void testCompilerTypedPercentage() throws Exception {
        File jsFile = new File("test.js");
        try (FileWriter writer = new FileWriter(jsFile)) {
            writer.write(JS_CODE);
        }

        ProcessBuilder pb = new ProcessBuilder(
            "java", "-jar", "compiler.jar",
            "--jscomp_error", "checkTypes",
            "--summary_detail_level", "3",
            "--js", "test.js",
            "--js_output_file", "compiled.js"
        );
        pb.redirectErrorStream(true);
        Process process = pb.start();
        
        BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()));
        String line;
        boolean foundTypedPercentage = false;
        while ((line = reader.readLine()) != null) {
            if (line.contains("typed")) {
                System.out.println(line);
                foundTypedPercentage = true;
                assertTrue("Typed percentage reported was not as expected",
                    line.contains("100% typed"));
            }
        }
        
        process.waitFor();
        jsFile.delete();
        new File("compiled.js").delete();

        assertTrue("Typed percentage line not found in output", foundTypedPercentage);
    }
}
