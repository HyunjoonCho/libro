
import com.google.javascript.jscomp.Compiler;
import com.google.javascript.jscomp.CompilerOptions;
import com.google.javascript.jscomp.SourceFile;
import org.junit.Test;

public class SmartNameRemovalTest {

    @Test(expected = IllegalStateException.class)
    public void testSmartNameRemovalCausingCompilerCrash() {
        Compiler compiler = new Compiler();
        CompilerOptions options = new CompilerOptions();

        // Enable advanced optimizations which include smartNameRemoval
        options.setLanguageIn(CompilerOptions.LanguageMode.ECMASCRIPT3);
        options.setLanguageOut(CompilerOptions.LanguageMode.ECMASCRIPT3);
        options.setOptimizationLevel(CompilerOptions.OptimizationLevel.ADVANCED_OPTIMIZATIONS);

        // JavaScript code that causes compiler crash
        String code = 
            "var goog = {};\n" +
            "goog.inherits = function(x, y) {};\n" +
            "var ns = {};\n" +
            "/** @constructor */ ns.PageSelectionModel = function(){};\n" +

            "/** @constructor */ \n" +
            "ns.PageSelectionModel.FooEvent = function() {};\n" +
            "/** @constructor */ \n" +
            "ns.PageSelectionModel.SelectEvent = function() {};\n" +
            "goog.inherits(ns.PageSelectionModel.ChangeEvent, ns.PageSelectionModel.FooEvent);";

        // Compile the JavaScript code
        compiler.compile(SourceFile.fromCode("externs.js", ""), SourceFile.fromCode("test.js", code), options);
    }
}
