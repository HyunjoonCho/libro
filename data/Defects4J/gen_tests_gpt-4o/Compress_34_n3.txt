
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.FileOutputStream;
import java.nio.file.Files;
import java.util.zip.ZipEntry;
import java.util.zip.ZipOutputStream;

import org.apache.commons.compress.archivers.zip.ZipFile;
import org.apache.tika.Tika;

public class CompressTest {

    public void testZeroSizedUXEntry() throws Exception {
        // Create a byte array protected zip file with 0-sized "ux" local entry
        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        try (ZipOutputStream zos = new ZipOutputStream(baos)) {
            ZipEntry entry = new ZipEntry("test.jpg");
            entry.setExtra(new byte[]{85, 84, 5, 0, 7, -112, -108, 51, 85, 117, 120, 0, 0});
            zos.putNextEntry(entry);
            zos.write(new byte[]{1, 2, 3}); // Fake image content
            zos.closeEntry();
        }

        byte[] zipContent = baos.toByteArray();

        // Use Apache Tika and Apache Commons Compress to trigger the issue
        File tempZipFile = File.createTempFile("testZeroSizedUXEntry", ".zip");
        try (FileOutputStream fos = new FileOutputStream(tempZipFile)) {
            fos.write(zipContent);
        }

        Tika tika = new Tika();
        
        try {
            tika.detect(Files.readAllBytes(tempZipFile.toPath()), "test.zip");
        } catch (ArrayIndexOutOfBoundsException e) {
            System.out.println("Test failed with exception: " + e);
            assert false : "Test failed with unexpected ArrayIndexOutOfBoundsException";
        } finally {
            tempZipFile.delete(); // Clean-up the temporary file
        }
    }

    public static void main(String[] args) {
        try {
            CompressTest ct = new CompressTest();
            ct.testZeroSizedUXEntry();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
