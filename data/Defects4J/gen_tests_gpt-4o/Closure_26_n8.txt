public void testProcessCommonJSModulesWithCheckTypes() {
    String echoJs = "define(function() { return {" +
                    "    echo: function(val) {" +
                    "        window.console.log(val);" +
                    "    }" +
                    "}});";
    
    String echoMainJs = "var echo = require('echo');" +
                        "echo.echo('hello world');";
    
    try {
        Process compileProcess = new ProcessBuilder(
            "java", 
            "-jar", "build/compiler.jar",
            "--formatting=PRETTY_PRINT",
            "--jscomp_error=checkTypes",
            "--compilation_level=SIMPLE_OPTIMIZATIONS",
            "--transform_amd_modules",
            "--process_common_js_modules",
            "--js=echo.js",
            "--js=echo-main.js",
            "--common_js_entry_module=echo-main.js"
        ).start();
        
        compileProcess.waitFor();
        
        BufferedReader errorReader = new BufferedReader(new InputStreamReader(compileProcess.getErrorStream()));
        String errorLine;
        boolean errorOccurred = false;
        
        while ((errorLine = errorReader.readLine()) != null) {
            if (errorLine.contains("ERROR - Property module$exports never defined on module$echo_main")) {
                errorOccurred = true;
                break;
            }
        }
        
        assertTrue("Compilation error for module$exports not occurring", errorOccurred);
        
    } catch (IOException | InterruptedException e) {
        fail("Failed to compile due to IOException or InterruptedException: " + e.getMessage());
    }
}