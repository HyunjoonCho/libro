
import org.apache.commons.jxpath.JXPathContext;
import org.apache.commons.jxpath.Pointer;
import org.apache.commons.jxpath.xml.DOMParser;
import org.junit.Test;
import org.w3c.dom.Document;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;

import static org.junit.Assert.assertEquals;

public class NamespaceTest {

    @Test
    public void testNamespaceLoopIssue() throws Exception {
        String xml = "<root xmlns:b=\"bla\" xmlns=\"test111\">"
                + "<b:foo>"
                + "<b:bar>a</b:bar>"
                + "<test xmlns=\"\"></test>"  // node without a namespace
                + "</b:foo>"
                + "</root>";

        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
        factory.setNamespaceAware(true);
        DocumentBuilder builder = factory.newDocumentBuilder();
        Document document = builder.parse(new java.io.ByteArrayInputStream(xml.getBytes()));

        JXPathContext context = JXPathContext.newContext(document);

        // Obtain the pointer to the 'test' node
        Pointer pointer = context.getPointer("//test");

        // Attempt to execute .asPath() method which leads to the reported bug
        String path = pointer.asPath();

        // The expected path considering the fix for the namespace issue
        assertEquals("/root/foo/test[1]", path);
    }
}
