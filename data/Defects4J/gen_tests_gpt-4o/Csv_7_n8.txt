
import static org.junit.jupiter.api.Assertions.*;
import org.apache.commons.csv.CSVFormat;
import org.apache.commons.csv.CSVParser;
import org.apache.commons.csv.CSVRecord;
import org.junit.jupiter.api.Test;

import java.io.IOException;
import java.io.StringReader;
import java.util.Map;

public class HeaderMapDuplicateColumnsTest {

    @Test
    public void testHeaderMapWithDuplicateColumns() throws IOException {
        // Sample CSV data with duplicate header names (Col2)
        String csvData = "Col1,Col2,Col2,Col3,Col4\n" +
                         "1,2,3,4,5\n" +
                         "4,5,6,7,8\n";

        CSVFormat myFormat = CSVFormat.RFC4180
                                        .withDelimiter(',')
                                        .withQuoteChar('"')
                                        .withQuotePolicy(CSVFormat.DEFAULT.withQuotePolicy())
                                        .withIgnoreSurroundingSpaces(true)
                                        .withHeader()
                                        .withSkipHeaderRecord(true);

        try (CSVParser parser = new CSVParser(new StringReader(csvData), myFormat)) {
            for (CSVRecord record : parser) {
                Map<String, Integer> headerMap = parser.getHeaderMap();
                
                // Check if headerMap has missing entries
                assertTrue(headerMap.containsKey("Col1"), "HeaderMap should contain 'Col1'");
                assertTrue(headerMap.containsKey("Col2"), "HeaderMap should contain 'Col2'");
                assertTrue(headerMap.containsKey("Col3"), "HeaderMap should contain 'Col3'");
                assertTrue(headerMap.containsKey("Col4"), "HeaderMap should contain 'Col4'");
                
                // Since "Col2" is duplicated, check how many times it is stored in the headerMap
                int col2Occurrences = 0;
                for (String header : headerMap.keySet()) {
                    if (header.equals("Col2")) {
                        col2Occurrences++;
                    }
                }
                assertEquals(1, col2Occurrences, "HeaderMap should store 'Col2' exactly once");
            }
        }
    }
}
