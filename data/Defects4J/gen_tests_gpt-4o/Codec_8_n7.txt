
import org.apache.commons.codec.binary.Base64InputStream;
import org.junit.Test;

import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.nio.charset.StandardCharsets;

import static org.junit.Assert.fail;

public class Base64InputStreamTest {

    @Test
    public void testArrayIndexOutOfBoundsOnMultipleReads() {
        // Prepare a byte array with enough data to trigger the exception on multiple reads
        byte[] inputData = new byte[32768]; // Create an array bigger than the problem's threshold
        for (int i = 0; i < inputData.length; i++) {
            inputData[i] = (byte) ('a' + (i % 26)); // Fill with dummy data
        }

        try (Base64InputStream base64InputStream = new Base64InputStream(new ByteArrayInputStream(inputData), true)) {
            int n = 0;
            try {
                while (base64InputStream.read() != -1) {
                    n++;
                }
            } catch (ArrayIndexOutOfBoundsException e) {
                // We expect this exception to be thrown as per the bug report
                System.out.println("Exception occurred after " + n + " reads.");
                e.printStackTrace();
                return; // Test succeeds if we catch the expected exception
            }
            fail("Expected ArrayIndexOutOfBoundsException was not thrown.");
        } catch (IOException e) {
            fail("IOException occurred: " + e.getMessage());
        }
    }
}
