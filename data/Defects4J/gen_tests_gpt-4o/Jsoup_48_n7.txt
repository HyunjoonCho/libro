
import org.jsoup.Connection;
import org.jsoup.Jsoup;
import org.jsoup.helper.HttpConnection;
import org.jsoup.nodes.Document;
import org.junit.Test;

import java.io.IOException;
import java.util.List;
import java.util.Map;

import static org.junit.Assert.assertEquals;

public class JsoupHeaderTest {

    @Test
    public void testDuplicateResponseHeaders() throws IOException {
        // Mocking a connection using HttpConnection.Response
        HttpConnection.Response response = new HttpConnection.Response(null);
        response.header("X-Powered-By", "PHP/5.2.8");
        response.header("X-Powered-By", "ASP.NET");

        // Simulating the processResponseHeaders behavior
        // Here we manually combine headers as per the suggested bug fix
        Map<String, List<String>> headersMap = response.multiHeaders();
        for (Map.Entry<String, List<String>> entry : headersMap.entrySet()) {
            String name = entry.getKey();
            if (name.equalsIgnoreCase("X-Powered-By")) {
                List<String> values = entry.getValue();
                StringBuilder combinedValues = new StringBuilder();
                for (String value : values) {
                    combinedValues.append(value).append(" ");
                }
                response.header(name, combinedValues.toString().trim());
            }
        }

        // Check that the header has both values combined
        assertEquals("PHP/5.2.8 ASP.NET", response.header("X-Powered-By"));
    }
}
