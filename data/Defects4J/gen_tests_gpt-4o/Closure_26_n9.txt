public void testProcessCommonJSModules() throws Exception {
    Compiler compiler = new Compiler();
    CompilerOptions options = new CompilerOptions();
    options.setPrettyPrint(true);
    options.setCheckTypes(true);
    options.setCompilationLevel(CompilationLevel.SIMPLE_OPTIMIZATIONS);
    options.setTransformAMDToCJSModules(true);
    options.setProcessCommonJSModules(true);

    SourceFile echoJs = SourceFile.fromCode("echo.js", 
        "define(function() { return { echo: function(val) { window.console.log(val); } }});");

    SourceFile echoMainJs = SourceFile.fromCode("echo-main.js", 
        "var echo = require('echo'); echo.echo('hello world');");

    compiler.compile(ImmutableList.of(), ImmutableList.of(echoJs, echoMainJs), options);

    assertEquals(0, compiler.getErrorCount());
}