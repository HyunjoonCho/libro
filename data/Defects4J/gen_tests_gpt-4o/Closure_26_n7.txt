public void testProcessCommonJSModules() {
    // Given the input JavaScript files
    String echoJs = "define(function() {" +
                    "  return {" +
                    "    echo: function(val) {" +
                    "      window.console.log(val);" +
                    "    }" +
                    "  };" +
                    "});";

    String echoMainJs = "var echo = require('echo');" +
                        "echo.echo('hello world');";

    CompilerOptions options = new CompilerOptions();
    CompilationLevel.SIMPLE_OPTIMIZATIONS.setOptionsForCompilationLevel(options);
    options.setPrettyPrint(true);
    options.setWarningLevel(DiagnosticGroups.CHECK_TYPES, CheckLevel.ERROR);
    options.setTransformAMDToCJSModules(true);
    options.setProcessCommonJSModules(true);
    options.setCommonJSEntryModule("echo-main.js");

    Compiler compiler = new Compiler();
    compiler.compile(
            CommandLineRunner.getDefaultExterns(),
            List.of(SourceFile.fromCode("echo.js", echoJs), 
                    SourceFile.fromCode("echo-main.js", echoMainJs)),
            options);

    assertEquals(0, compiler.getErrorCount());
    assertEquals(0, compiler.getWarningCount());
}