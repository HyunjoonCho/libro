
import org.apache.commons.csv.CSVFormat;
import org.apache.commons.csv.CSVParser;
import org.apache.commons.csv.CSVRecord;
import org.junit.Test;

import java.io.BufferedReader;
import java.io.StringReader;
import java.util.Iterator;

public class CSVParserTest {

    @Test
    public void testMultiIteratorBehaviorWithPeek() throws Exception {
        String fiveRows = "1\n2\n3\n4\n5\n";

        System.out.println("Enhanced for loop, no peeking:");
        CSVParser parser = new CSVParser(new BufferedReader(new StringReader(fiveRows)), CSVFormat.DEFAULT);
        int recordNumber = 0;
        for (CSVRecord record : parser) {
            recordNumber++;
            System.out.println(recordNumber + " -> " + record.get(0));
            if (recordNumber >= 2) {
                break;
            }
        }

        for (CSVRecord record : parser) {
            recordNumber++;
            System.out.println(recordNumber + " -> " + record.get(0));
        }

        // Expected Output
        // Enhanced for loop, no peeking:
        // 1 -> 1
        // 2 -> 2
        // 3 -> 3
        // 4 -> 4
        // 5 -> 5


        System.out.println("\nEnhanced for loop, with peek:");
        parser = new CSVParser(new BufferedReader(new StringReader(fiveRows)), CSVFormat.DEFAULT);
        recordNumber = 0;
        for (CSVRecord record : parser) {
            recordNumber++;
            System.out.println(recordNumber + " -> " + record.get(0));
            if (recordNumber >= 2) {
                break;
            }
        }

        System.out.println("hasNext(): " + parser.iterator().hasNext());

        for (CSVRecord record : parser) {
            recordNumber++;
            System.out.println(recordNumber + " -> " + record.get(0));
        }

        // Actual Output
        // Enhanced for loop, with peek:
        // 1 -> 1
        // 2 -> 2
        // hasNext(): true
        // 3 -> 4
        // 4 -> 5


        System.out.println("\nIterator while, with peek:");
        parser = new CSVParser(new BufferedReader(new StringReader(fiveRows)), CSVFormat.DEFAULT);
        recordNumber = 0;
        Iterator<CSVRecord> iter = parser.iterator();
        while (iter.hasNext()) {
            CSVRecord record = iter.next();
            recordNumber++;
            System.out.println(recordNumber + " -> " + record.get(0));
            if (recordNumber >= 2) {
                break;
            }
        }

        System.out.println("hasNext(): " + iter.hasNext());

        while (iter.hasNext()) {
            CSVRecord record = iter.next();
            recordNumber++;
            System.out.println(recordNumber + " -> " + record.get(0));
        }

        // Expected Output
        // Iterator while, with peek:
        // 1 -> 1
        // 2 -> 2
        // hasNext(): true
        // 3 -> 3
        // 4 -> 4
        // 5 -> 5
    }
}
