public void testVarianceEvaluateWithWeightsAndLength() {
    double[] values = {1.0, 2.0, 3.0, 4.0, 5.0};
    double[] weights = {1.0, 1.0, 1.0, 1.0, 1.0};
    double mean = 3.0;
    int begin = 0;
    int length = 3;

    Variance variance = new Variance();
    double result = variance.evaluate(values, weights, mean, begin, length);

    // Variance of first three elements [1.0, 2.0, 3.0] with mean 3 should be 2
    assertEquals(varianceWithWeights(new double[]{1.0, 2.0, 3.0}, weights, mean), result, 1e-10);
}

private double varianceWithWeights(double[] values, double[] weights, double mean) {
    double variance = 0.0;
    for (int i = 0; i < values.length; i++) {
        variance += weights[i] * Math.pow(values[i] - mean, 2);
    }
    return variance / sum(weights, values.length);
}

private double sum(double[] weights, int length) {
    double sum = 0.0;
    for (int i = 0; i < length; i++) {
        sum += weights[i];
    }
    return sum;
}