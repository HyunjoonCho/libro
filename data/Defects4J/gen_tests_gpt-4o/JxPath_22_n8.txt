
import org.apache.commons.jxpath.JXPathContext;
import org.apache.commons.jxpath.Pointer;
import org.apache.commons.jxpath.xml.DOMParser;
import org.junit.Test;
import org.w3c.dom.Document;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;

import static org.junit.Assert.fail;

public class NamespaceLoopTest {

    @Test
    public void testDefaultNamespaceLoop() {
        try {
            String xml = "<root xmlns:b=\"bla\" xmlns=\"test111\">" +
                         "<b:foo>" +
                         "<b:bar>a</b:bar>" +
                         "<test xmlns=\"\">Hello</test>" +
                         "</b:foo>" +
                         "</root>";

            DocumentBuilder builder = DocumentBuilderFactory.newInstance().newDocumentBuilder();
            Document doc = builder.parse(new java.io.ByteArrayInputStream(xml.getBytes()));

            JXPathContext context = JXPathContext.newContext(doc);

            // Select the 'test' node that should potentially cause the loop
            Pointer pointer = context.getPointer("/root/b:foo/test");
            assert pointer != null;

            // Attempting to call asPath() to see if it causes loop or wrong path
            System.out.println(pointer.asPath());

        } catch (Exception e) {
            fail("An exception occurred: " + e.getMessage());
        }
    }
}
