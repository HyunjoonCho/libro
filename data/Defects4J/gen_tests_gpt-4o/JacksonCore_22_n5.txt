
import com.fasterxml.jackson.core.JsonFactory;
import com.fasterxml.jackson.core.JsonGenerator;
import com.fasterxml.jackson.core.JsonParser;
import com.fasterxml.jackson.core.filter.FilteringGeneratorDelegate;
import com.fasterxml.jackson.core.filter.TokenFilter;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.junit.Test;

import java.io.IOException;
import java.io.StringWriter;

import static org.junit.Assert.assertEquals;

public class FilteringParserDelegateTest {

    @Test
    public void testFilteringGeneratorWithMatchCount() throws IOException {
        // Define a simple JSON structure
        String json = "{\"field1\":\"value1\",\"field2\":\"value2\",\"field3\":\"value3\"}";
        
        // Create a parser and generator with filtering capabilities
        ObjectMapper mapper = new ObjectMapper();
        JsonFactory factory = new JsonFactory();

        StringWriter writer = new StringWriter();
        JsonGenerator generator = factory.createGenerator(writer);

        TokenFilter filter = new TokenFilter() {
            @Override
            public TokenFilter includeProperty(String name) {
                // Filter to include only specific fields, for instance
                return "field1".equals(name) ? TokenFilter.INCLUDE_ALL : null;
            }
        };

        FilteringGeneratorDelegate filteringGenerator =
                new FilteringGeneratorDelegate(generator, filter, true, true);

        // Parse and filter the JSON content
        JsonParser parser = factory.createParser(json);
        while (parser.nextToken() != null) {
            filteringGenerator.copyCurrentEvent(parser);
        }
        parser.close();
        filteringGenerator.close();

        // Expected filtered output
        String expectedJson = "{\"field1\":\"value1\"}";
        assertEquals("Filtered output should only contain field1", expectedJson, writer.toString());

        // After the fix, we expect _matchCount to be used, reflecting in operations.
        // This test case currently assumes no runtime impact by _matchCount due to the bug.
    }
}
