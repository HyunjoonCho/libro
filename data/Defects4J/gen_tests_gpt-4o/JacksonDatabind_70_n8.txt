
import com.fasterxml.jackson.annotation.JsonUnwrapped;
import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.MapperFeature;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.exc.UnrecognizedPropertyException;
import org.junit.Test;

import static org.junit.Assert.assertEquals;

public class JsonUnwrappedCaseInsensitiveTest {

    public static class Person {
        @JsonUnwrapped(prefix = "businessAddress.")
        public Address businessAddress;
    }

    public static class Address {
        public String street;
        public String addon;
        public String zip = "";
        public String town;
        public String country;
    }

    @Test
    public void testCaseInsensitiveUnwrapped() {
        String json = "{ \"businessAddress.street\": \"Main St\", " +
                      "\"businessaddress.ADDON\": \"Suite 100\", " +
                      "\"BusinessAddress.zip\": \"12345\", " +
                      "\"BUSINESSADDRESS.TOWN\": \"Sampletown\", " +
                      "\"BUSINESSaddress.country\": \"Countryland\" }";

        ObjectMapper mapper = new ObjectMapper();
        mapper.enable(MapperFeature.ACCEPT_CASE_INSENSITIVE_PROPERTIES);

        try {
            Person person = mapper.readValue(json, Person.class);

            assertEquals("Main St", person.businessAddress.street);
            assertEquals("Suite 100", person.businessAddress.addon);
            assertEquals("12345", person.businessAddress.zip);
            assertEquals("Sampletown", person.businessAddress.town);
            assertEquals("Countryland", person.businessAddress.country);
        } catch (UnrecognizedPropertyException e) {
            // The test should fail due to the exception occurring because of case-sensitivity issue
            throw new AssertionError("Failed to deserialize with ACCEPT_CASE_INSENSITIVE_PROPERTIES when using @JsonUnwrapped", e);
        } catch (Exception e) {
            throw new RuntimeException("An unexpected exception occurred during deserialization", e);
        }
    }
}
