public void testEndlessLoopInAsPath() {
    try {
        // Setup the DOM structure
        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
        factory.setNamespaceAware(true);
        DocumentBuilder builder = factory.newDocumentBuilder();
        String xml = "<b:foo xmlns:b='bla' xmlns='test111'>"
                   + "<b:bar>a</b:bar>"
                   + "<test xmlns=''></test>"
                   + "</b:foo>";
        Document document = builder.parse(new InputSource(new StringReader(xml)));

        // Initialize JXPath context
        JXPathContext context = JXPathContext.newContext(document);

        // Obtain the node in question
        Object testNode = context.getValue("/b:foo/test");

        // Attempt to get the XPath as a string for the 'test' node
        NodePointer nodePointer = NodePointer.newNodePointer(new QName("test"), testNode, null);
        String xpath = nodePointer.asPath();

        // Check that the xpath does not loop and returns a valid path
        assertNotNull(xpath);
        assertFalse(xpath.contains("//b:fo/null:test"));

    } catch (Exception e) {
        fail("The test failed due to an unexpected exception: " + e.getMessage());
    }
}