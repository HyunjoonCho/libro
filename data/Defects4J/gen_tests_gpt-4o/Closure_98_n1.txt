script
const { expect } = require('chai');
const { exec } = require('child_process');

describe('Closure Compiler Variable Inlining Bug', function() {
    it('should log each number in the array correctly', function(done) {
        let expectedOutput = '1\n2\n3\n4\n5\n';
        exec('node', ['-e', `
            function foo() {
                var arr = [1, 2, 3, 4, 5];
                for (var i = 0, l = arr.length; i < l; i++) {
                    var j = arr[i];
                    (function() {
                        var k = j;
                        setTimeout(function() { console.log(k); }, 0);
                    })();
                }
            }
            foo();
        `], (err, stdout, stderr) => {
            if (err) {
                done(err);
            } else {
                expect(stdout).to.equal(expectedOutput);
                done();
            }
        });
    });
});
