public void testTypeRefiningThis() {
    String code = "function test() { if (goog.isFunction(this)) { /* do something */ } }";
    
    Compiler compiler = new Compiler();
    CompilerOptions options = new CompilerOptions();
    CompilationLevel.SIMPLE_OPTIMIZATIONS.setOptionsForCompilationLevel(options);
    Result result = compiler.compile(
        CommandLineRunner.getDefaultExterns(),
        ImmutableList.of(SourceFile.fromCode("input.js", code)),
        options
    );

    assertFalse("Compilation should fail with IllegalArgumentException", result.success);
    assertTrue("Error should contain 'Node cannot be refined'",
        compiler.getErrorManager().getErrors()[0].description.contains("Node cannot be refined"));
}