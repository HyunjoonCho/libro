
import org.junit.Test;
import java.io.*;

import static org.junit.Assert.assertTrue;

public class CompilerErrorTest {

    @Test
    public void testMissingCaretInErrorOutput() throws IOException, InterruptedException {
        String testJsContentWithoutCaret = "alert(1;";
        String testJsContentWithCaret = "alert(1;\n";

        File fileWithoutCaret = createTempJsFile(testJsContentWithoutCaret);
        File fileWithCaret = createTempJsFile(testJsContentWithCaret);

        String outputWithoutCaret = runCompilerAndGetOutput(fileWithoutCaret);
        String outputWithCaret = runCompilerAndGetOutput(fileWithCaret);

        assertTrue("Error output without caret should not contain '^'", !outputWithoutCaret.contains("^"));
        assertTrue("Error output with caret should contain '^'", outputWithCaret.contains("^"));
    }

    private File createTempJsFile(String content) throws IOException {
        File tempFile = File.createTempFile("test", ".js");
        try (FileWriter writer = new FileWriter(tempFile)) {
            writer.write(content);
        }
        tempFile.deleteOnExit();
        return tempFile;
    }

    private String runCompilerAndGetOutput(File jsFile) throws IOException, InterruptedException {
        ProcessBuilder processBuilder = new ProcessBuilder("java", "-jar", "compiler.jar", "--js", jsFile.getAbsolutePath());
        processBuilder.redirectErrorStream(true);
        Process process = processBuilder.start();

        try (BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()))) {
            StringBuilder output = new StringBuilder();
            String line;
            while ((line = reader.readLine()) != null) {
                output.append(line).append("\n");
            }
            process.waitFor();
            return output.toString();
        }
    }
}
