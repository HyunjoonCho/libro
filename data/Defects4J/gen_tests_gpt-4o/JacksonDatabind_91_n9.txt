
import org.apache.logging.log4j.core.LogEvent;
import org.apache.logging.log4j.core.parser.JsonLogEventParser;
import org.apache.logging.log4j.core.parser.LogEventParser;
import org.apache.logging.log4j.core.parser.ParseException;
import org.junit.Test;

import java.nio.charset.StandardCharsets;

import static org.junit.Assert.assertNotNull;

public class Log4jDeserializationRegressionTest {

    private static final String INPUT_STRING = "{"
            + "\"timeMillis\" : 1493121664118,"
            + "\"thread\" : \"main\","
            + "\"threadId\" : 1,"
            + "\"threadPriority\" : 5,"
            + "\"level\" : \"INFO\","
            + "\"loggerName\" : \"HelloWorld\","
            + "\"marker\" : {"
            + "  \"name\" : \"child\","
            + "  \"parents\" : [ {"
            + "    \"name\" : \"parent\","
            + "    \"parents\" : [ {"
            + "      \"name\" : \"grandparent\""
            + "    } ]"
            + "  } ]"
            + "},"
            + "\"message\" : \"Hello, world!\","
            + "\"thrown\" : {"
            + "  \"commonElementCount\" : 0,"
            + "  \"message\" : \"error message\","
            + "  \"name\" : \"java.lang.RuntimeException\","
            + "  \"extendedStackTrace\" : [ {"
            + "    \"class\" : \"logtest.Main\","
            + "    \"method\" : \"main\","
            + "    \"file\" : \"Main.java\","
            + "    \"line\" : 29,"
            + "    \"exact\" : true,"
            + "    \"location\" : \"classes/\","
            + "    \"version\" : \"?\""
            + "  } ]"
            + "},"
            + "\"contextStack\" : [ \"one\", \"two\" ],"
            + "\"loggerFqcn\" : \"org.apache.logging.log4j.spi.AbstractLogger\","
            + "\"endOfBatch\" : false,"
            + "\"contextMap\" : {"
            + "  \"bar\" : \"BAR\","
            + "  \"foo\" : \"FOO\""
            + "},"
            + "\"source\" : {"
            + "  \"class\" : \"logtest.Main\","
            + "  \"method\" : \"main\","
            + "  \"file\" : \"Main.java\","
            + "  \"line\" : 29"
            + "}"
            + "}";

    @Test
    public void testJsonDeserializationRegression() throws ParseException {
        LogEventParser parser = new JsonLogEventParser();
        LogEvent result = parser.parseFrom(INPUT_STRING.getBytes(StandardCharsets.UTF_8));

        // Assert that the result is not null if deserialization succeeds
        assertNotNull("Deserialization failed. The resulting LogEvent should not be null.", result);
    }
}
