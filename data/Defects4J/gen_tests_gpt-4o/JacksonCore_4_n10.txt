
import com.fasterxml.jackson.core.JsonFactory;
import com.fasterxml.jackson.core.JsonParser;
import com.fasterxml.jackson.core.JsonToken;
import org.junit.Test;

import java.io.IOException;
import java.io.StringReader;

public class LongJsonKeyTest {

    @Test(expected = ArrayIndexOutOfBoundsException.class)
    public void testJsonParserWithLongKey() throws IOException {
        // Create a key longer than 262144 characters
        StringBuilder longKeyBuilder = new StringBuilder();
        for (int i = 0; i <= 262144; i++) {
            longKeyBuilder.append('a');
        }
        String longKey = longKeyBuilder.toString();

        // Create a JSON object as a string with the long key
        String json = "{\"" + longKey + "\": \"value\"}";

        // Use Jackson's JsonParser to parse the JSON
        JsonFactory jsonFactory = new JsonFactory();
        try (JsonParser parser = jsonFactory.createParser(new StringReader(json))) {
            while (parser.nextToken() != JsonToken.END_OBJECT) {
                // Process the JSON tokens. In this case, we're just iterating to
                // trigger the key parsing which should cause the exception.
            }
        }
    }
}
