
import com.google.javascript.jscomp.*;
import com.google.javascript.rhino.jstype.JSTypeRegistry;
import org.junit.Test;

import java.util.ArrayList;
import java.util.List;

import static org.junit.Assert.*;

public class CompilerTest {

    @Test
    public void testResolveTypesUnionTypeCastToObjectType() {
        // Create an instance of the compiler
        Compiler compiler = new Compiler();

        // Set up the compiler options
        CompilerOptions options = new CompilerOptions();
        options.setWarningLevel(DiagnosticGroups.MISSING_PROPERTIES, CheckLevel.WARNING);
        options.setWarningLevel(DiagnosticGroups.UNDEFINED_VARIABLES, CheckLevel.WARNING);
        options.setWarningLevel(DiagnosticGroups.CHECK_TYPES, CheckLevel.WARNING);
        options.setWarningLevel(DiagnosticGroups.STRICT_MODULE_DEP_CHECK, CheckLevel.ERROR);
        options.setWarningLevel(DiagnosticGroups.INVALID_CASTS, CheckLevel.ERROR);
        options.setCompilationLevel(CompilationLevel.ADVANCED_OPTIMIZATIONS);
        options.setProcessClosurePrimitives(true);

        // Example JavaScript source code that could trigger the issue
        String jsSource = "var a = {};\n" +
                          "a.x = function() {};\n" +
                          "/** @type {(number|string)} */ var y = a;\n" +
                          "y();";

        // Create the source file
        SourceFile external = SourceFile.fromCode("externs.js", "");
        SourceFile input = SourceFile.fromCode("input.js", jsSource);

        try {
            // Compile the source files
            compiler.compile(external, input, options);
            // If no exception is thrown, the test passes
            // Optionally check the compiled code if needed

        } catch (RuntimeException e) {
            // Catch and check the specific exception that was described in the bug
            assertTrue(e.getCause() instanceof ClassCastException);
            assertTrue(e.getCause().getMessage().contains("com.google.javascript.rhino.jstype.UnionType cannot be cast to com.google.javascript.rhino.jstype.ObjectType"));
        }
    }
}
