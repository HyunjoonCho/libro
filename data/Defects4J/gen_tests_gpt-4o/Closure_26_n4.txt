public void testProcessCommonJSModulesWithCheckTypes() {
    String jsEcho = "define(function() { return { echo: function(val) { window.console.log(val); }}});";
    String jsEntryPoint = "var echo = require('echo'); echo.echo('hello world');";
    
    CompilerOptions options = new CompilerOptions();
    options.setCheckTypes(true);
    options.setPrettyPrint(true);
    options.setCompilationLevel(CompilationLevel.SIMPLE_OPTIMIZATIONS);
    options.setTransformAMDToCJSModules(true);
    options.setProcessCommonJsModules(true);
    options.setCommonJsEntryModule("echo-main.js");
    
    List<SourceFile> inputs = Arrays.asList(
        SourceFile.fromCode("echo.js", jsEcho),
        SourceFile.fromCode("echo-main.js", jsEntryPoint)
    );
    
    Compiler compiler = new Compiler();
    compiler.compile(Collections.emptyList(), inputs, options);
    
    assertEquals(0, compiler.getErrorCount());
}