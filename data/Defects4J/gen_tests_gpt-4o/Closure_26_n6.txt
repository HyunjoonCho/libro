public void testProcessCommonJSModulesFailure() {
    CompilerOptions options = new CompilerOptions();
    options.setPrettyPrint(true);
    options.setErrorLevel(DiagnosticGroups.CHECK_TYPES, CheckLevel.ERROR);
    options.setCompilationLevel(CompilationLevel.SIMPLE_OPTIMIZATIONS);
    options.setTransformAMDModules(true);
    options.setProcessCommonJSModules(true);
    options.setCommonJSEntryModule("echo-main.js");

    String echoJs = "define(function() { return { echo: function(val) { window.console.log(val); }}});";
    String echoMainJs = "var echo = require('echo'); echo.echo('hello world');";

    Compiler compiler = new Compiler();
    Result result = compiler.compile(
        SourceFile.fromCode("externs.js", ""),
        ImmutableList.of(
            SourceFile.fromCode("echo.js", echoJs),
            SourceFile.fromCode("echo-main.js", echoMainJs)
        ),
        options
    );

    assertFalse("Compilation should have failed with type check error", result.success);
    assertTrue("Expected error about missing module$exports", result.errors[0].description.contains("Property module$exports never defined on module$echo_main"));
}