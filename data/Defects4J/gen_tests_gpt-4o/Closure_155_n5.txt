
import org.graalvm.polyglot.Context;
import org.graalvm.polyglot.Value;
import org.junit.Test;

import static org.junit.Assert.assertEquals;

public class JavaScriptOptimizationTest {

    @Test
    public void testOverzealousArgumentsOptimization() {
        try (Context context = Context.create("js")) {
            // JavaScript code with utility function
            String script = 
                "function d3_call(callback) {" +
                "   var f = callback;" +
                "   arguments[0] = this;" +
                "   return f.apply(this, arguments);" +
                "}" +
                "function testFunction(a, b) {" +
                "   return [a, b];" +
                "}" +
                "var resultOriginal = d3_call.call([1, 2], testFunction);";

            context.eval("js", script);
            Value result = context.getBindings("js").getMember("resultOriginal");
            assertEquals(1, result.getArrayElement(0).asInt());
            assertEquals(2, result.getArrayElement(1).asInt());
        }
    }
}
