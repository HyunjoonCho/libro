
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.JsonMappingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.junit.Test;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertTrue;

public class TreeTraversingParserBoundsTest {

    public static class IntClass {
        public int x;

        @Override
        public String toString() {
            return String.valueOf(x);
        }
    }

    ObjectMapper mapper = new ObjectMapper();

    private void readAndAssert(String example, String expectedFromTree, String expectedFromString) {
        String fromTree;
        try {
            JsonNode tree = mapper.readTree(example);
            fromTree = mapper.readerFor(IntClass.class).readValue(tree).toString();
        } catch (IOException e) {
            fromTree = e.getClass().getSimpleName();
        }

        String fromString;
        try {
            fromString = mapper.readerFor(IntClass.class).readValue(example).toString();
        } catch (IOException e) {
            fromString = e.getClass().getSimpleName();
        }

        assertEquals("Mismatch for JSON: " + example + " (Tree)", expectedFromTree, fromTree);
        assertEquals("Mismatch for JSON: " + example + " (String)", expectedFromString, fromString);
    }

    @Test
    public void testBoundsCheck() {
        // Test cases with expected values from the bug report
        readAndAssert("{\"x\": 0}", "0", "0");
        readAndAssert("{\"x\": 10}", "10", "10");
        readAndAssert("{\"x\": 1e4}", "10000", "10000");
        readAndAssert("{\"x\": 1e10}", "2147483647", JsonMappingException.class.getSimpleName());
        readAndAssert("{\"x\": 2147483648}", "-2147483648", JsonMappingException.class.getSimpleName());
        readAndAssert("{\"x\": 2147483649}", "-2147483647", JsonMappingException.class.getSimpleName());
        readAndAssert("{\"x\": -2147483649}", "2147483647", JsonMappingException.class.getSimpleName());
        readAndAssert("{\"x\": -4294967295}", "1", JsonMappingException.class.getSimpleName());
        readAndAssert("{\"x\": true}", "MismatchedInputException", "MismatchedInputException");
        readAndAssert("{\"x\": {}}", "MismatchedInputException", "MismatchedInputException");
        readAndAssert("{\"x\": []}", "MismatchedInputException", "MismatchedInputException");
        readAndAssert("{\"x\": [0]}", "MismatchedInputException", "MismatchedInputException");
        readAndAssert("{\"x\": \"0\"}", "0", "0");
        readAndAssert("{\"x\": \"10\"}", "10", "10");
        readAndAssert("{\"x\": \"1e4\"}", "InvalidFormatException", "InvalidFormatException");
        readAndAssert("{\"x\": \"1e10\"}", "InvalidFormatException", "InvalidFormatException");
        readAndAssert("{\"x\": \"1e-1\"}", "InvalidFormatException", "InvalidFormatException");
        readAndAssert("{\"x\": \"2147483648\"}", "InvalidFormatException", "InvalidFormatException");
        readAndAssert("{\"x\": \"2147483649\"}", "InvalidFormatException", "InvalidFormatException");
        readAndAssert("{\"x\": \"-2147483649\"}", "InvalidFormatException", "InvalidFormatException");
        readAndAssert("{\"x\": \"-4294967295\"}", "InvalidFormatException", "InvalidFormatException");
        readAndAssert("{\"x\": \"0.1\"}", "InvalidFormatException", "InvalidFormatException");
        readAndAssert("{\"x\": \"1.9\"}", "InvalidFormatException", "InvalidFormatException");
        readAndAssert("{\"x\": \"1.9999999999999999\"}", "InvalidFormatException", "InvalidFormatException");
        readAndAssert("{\"x\": \"true\"}", "InvalidFormatException", "InvalidFormatException");
        readAndAssert("{\"x\": \"{}\"}", "InvalidFormatException", "InvalidFormatException");
        readAndAssert("{\"x\": \"[]\"}", "InvalidFormatException", "InvalidFormatException");
        readAndAssert("{\"x\": \"[0]\"}", "InvalidFormatException", "InvalidFormatException");
    }
}
