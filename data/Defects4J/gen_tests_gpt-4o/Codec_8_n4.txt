
import org.apache.commons.codec.binary.Base64InputStream;
import org.junit.Test;

import java.io.ByteArrayInputStream;
import java.io.IOException;

import static org.junit.Assert.fail;

public class Base64InputStreamTest {

    @Test
    public void testArrayIndexOutOfBoundsException() {
        // Generate a sizable input stream to trigger the ArrayIndexOutOfBoundsException
        // The data should be large enough to require multiple internal buffer expansions
        byte[] inputData = new byte[10920]; // The size reported in the bug
        for (int i = 0; i < inputData.length; i++) {
            inputData[i] = (byte) (i % 256); // Populate with incremental bytes
        }
        
        ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(inputData);
        Base64InputStream b64stream = new Base64InputStream(byteArrayInputStream, true, 0, null);
        int n = 0;

        try {
            while (b64stream.read() != -1) {
                n++;
            }
        } catch (ArrayIndexOutOfBoundsException e) {
            // Expected exception to be asserted for fixing/improvement of the issue
            fail("ArrayIndexOutOfBoundsException occurred after " + n + " reads.");
        } catch (IOException e) {
            fail("IOException occurred: " + e.getMessage());
        }
    }
}
