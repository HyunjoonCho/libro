
import com.fasterxml.jackson.core.JsonFactory;
import com.fasterxml.jackson.core.JsonParser;
import com.fasterxml.jackson.core.JsonToken;
import org.junit.Test;

import java.io.IOException;

public class JacksonKeyLengthTest {

    @Test(expected = ArrayIndexOutOfBoundsException.class)
    public void testLongJsonKey() throws IOException {
        // Create a long key of 262145 characters ('a') to exceed the limit
        StringBuilder longKeyBuilder = new StringBuilder();
        for (int i = 0; i < 262145; i++) {
            longKeyBuilder.append("a");
        }
        String longKey = longKeyBuilder.toString();

        // Construct the JSON string with the long key
        String json = "{\"" + longKey + "\": \"value\"}";

        JsonFactory jsonFactory = new JsonFactory();

        try (JsonParser parser = jsonFactory.createParser(json)) {
            while (!parser.isClosed()) {
                JsonToken token = parser.nextToken();
                if (token == JsonToken.FIELD_NAME) {
                    // Force parsing of the field name to trigger the bug
                    parser.getCurrentName();
                }
            }
        }
    }
}
