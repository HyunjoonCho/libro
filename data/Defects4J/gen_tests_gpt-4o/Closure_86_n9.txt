
import org.junit.Test;
import static org.junit.Assert.*;

import javax.script.Invocable;
import javax.script.ScriptEngine;
import javax.script.ScriptEngineManager;
import javax.script.ScriptException;

public class SideEffectsTest {

    @Test
    public void testSideEffectsNotRemoved() throws ScriptException, NoSuchMethodException {
        // Construct the JavaScript code
        String jsCode = 
            "/** @constructor */\n" +
            "function Foo() {\n" +
            "  var self = this;\n" +
            "  window = { setTimeout: function(func, delay) { self.locationPending = func; } };\n" + // simulate setTimeout
            "}\n" +
            "\n" +
            "Foo.prototype.setLocation = function(loc) {\n" +
            "  this.location = loc;\n" +
            "};\n" +
            "\n" +
            "(new Foo()).setLocation('http://www.google.com/');\n" +
            "var fooInstance = new Foo();\n" +
            "fooInstance.setLocation('http://www.example.com/');\n" +
            "fooInstance.location"; // return the location value to test

        // Create a script engine manager
        ScriptEngineManager manager = new ScriptEngineManager();
        ScriptEngine engine = manager.getEngineByName("JavaScript");

        // Evaluate the JavaScript code
        Object result = engine.eval(jsCode);
        
        // Validate the output
        assertEquals("http://www.example.com/", result);
    }
}
