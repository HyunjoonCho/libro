
import com.google.javascript.jscomp.CompilationLevel;
import com.google.javascript.jscomp.Compiler;
import com.google.javascript.jscomp.CompilerOptions;
import com.google.javascript.jscomp.JSSourceFile;
import com.google.javascript.rhino.head.ErrorReporter;
import com.google.javascript.rhino.head.EvaluatorException;
import org.junit.Test;

public class SmartNameRemovalCrashTest {

    @Test(expected = RuntimeException.class)
    public void testSmartNameRemovalCausesCompilerCrash() {
        Compiler compiler = new Compiler(new ErrorReporter() {
            @Override
            public void warning(String s, String s1, int i, String s2, int i1) {
                // No operation
            }

            @Override
            public void error(String s, String s1, int i, String s2, int i1) {
                throw new RuntimeException("Compiler Error: " + s);
            }

            @Override
            public EvaluatorException runtimeError(String s, String s1, int i, String s2, int i1) {
                return new EvaluatorException("Evaluator Exception: " + s);
            }
        });

        CompilerOptions options = new CompilerOptions();
        CompilationLevel.ADVANCED_OPTIMIZATIONS.setOptionsForCompilationLevel(options);

        JSSourceFile extern = JSSourceFile.fromCode("externs.js", "");
        JSSourceFile input = JSSourceFile.fromCode("test.js", 
                "var goog = {};\n" +
                "goog.inherits = function(x, y) {};\n" +
                "var ns = {};\n" +
                "/** @constructor */ ns.PageSelectionModel = function(){};\n" +
                "/** @constructor */ ns.PageSelectionModel.FooEvent = function() {};\n" +
                "/** @constructor */ ns.PageSelectionModel.SelectEvent = function() {};\n" +
                "goog.inherits(ns.PageSelectionModel.ChangeEvent, ns.PageSelectionModel.FooEvent);\n"
        );

        compiler.compile(extern, input, options);
    }
}
