
import org.apache.commons.jxpath.JXPathContext;
import org.apache.commons.jxpath.Pointer;
import org.apache.commons.jxpath.xml.DocumentContainer;
import org.junit.Test;
import static org.junit.Assert.assertEquals;

public class NamespaceLoopBugTest {

    @Test
    public void testNamespaceLoopBug() throws Exception {
        String xml = "<root xmlns='test111' xmlns:b='bla'>"
                   + "<b:foo xmlns:b='bla' xmlns='test111'>"
                   + "  <b:bar>a</b:bar>"
                   + "  <test xmlns=''></test>"
                   + "</b:foo>"
                   + "</root>";

        DocumentContainer container = new DocumentContainer(xml);
        JXPathContext context = JXPathContext.newContext(container);

        Pointer pointer = context.getPointer("/root/b:foo/test");
        String asPath = pointer.asPath();

        // Expect the correct XPath without endless loop and error
        assertEquals("/root/b:foo[1]/test[1]", asPath);
    }
}
