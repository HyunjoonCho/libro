public void testBadVariableInliningInClosure() throws Exception {
    String output = runJavaScript(
        "function foo() {\n" +
        "    var arr = [1, 2, 3, 4, 5];\n" +
        "    for (var i = 0, l = arr.length; i < l; i++) {\n" +
        "        var j = arr[i];\n" +
        "        (function() {\n" +
        "            var k = j;\n" +
        "            setTimeout(function() { console.log(k); }, 0);\n" +
        "        })();\n" +
        "    }\n" +
        "}\n" +
        "foo();"
    );
    String expectedOutput = "1\n2\n3\n4\n5\n";
    assertEquals(expectedOutput, output);
}

private String runJavaScript(String script) throws Exception {
    ProcessBuilder processBuilder = new ProcessBuilder("node", "-e", script);
    Process process = processBuilder.start();
    try (BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()))) {
        StringBuilder output = new StringBuilder();
        String line;
        while ((line = reader.readLine()) != null) {
            output.append(line).append("\n");
        }
        return output.toString();
    }
}