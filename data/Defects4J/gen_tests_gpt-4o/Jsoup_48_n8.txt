
import org.jsoup.Connection;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.parser.Parser;
import org.junit.Test;

import java.util.HashMap;
import java.util.Map;

import static org.junit.Assert.assertEquals;

public class ResponseHeaderTest {

    @Test
    public void testDuplicateResponseHeaders() throws Exception {
        // Simulating a response with duplicate headers
        Map<String, String> headers = new HashMap<>();
        headers.put("Set-Cookie", "testCookie=abc123");
        headers.put("X-Powered-By", "PHP/5.2.8");
        headers.put("X-Powered-By", "ASP.NET");

        // Simulating a Jsoup Document loading with these headers
        Connection.Response response = Jsoup.connect("http://01pt.com/")
                .response();

        // Directly setting headers to simulate as if it was fetched
        response.headers(headers);

        // Testing if only the last "X-Powered-By" header is fetched
        assertEquals("ASP.NET", response.header("X-Powered-By"));

        // Simulating the fix where both values are concatenated
        String allValues = response.multiHeaders().get("X-Powered-By").stream()
                .reduce("", (a, b) -> a + (a.isEmpty() ? "" : " ") + b);

        // Asserting the concatenated value
        assertEquals("PHP/5.2.8 ASP.NET", allValues);
    }
}
