public void testProcessCommonJSModulesError() {
    // This would need to be run within the infrastructure that sets up the compiler environment.
    // Simulate the input JavaScript file contents:
    String echoJs = "define(function() { return { echo: function(val) { window.console.log(val); }} });";
    String echoMainJs = "var echo = require('echo'); echo.echo('hello world');";

    // Set up compiler options as described in the bug report:
    CompilerOptions options = new CompilerOptions();
    options.setPrettyPrint(true);
    options.setCheckTypes(true);
    options.setCompilationLevel(CompilationLevel.SIMPLE_OPTIMIZATIONS);
    options.setTransformAMDModules(true);
    options.setProcessCommonJSModules(true);

    // Create a mock file system and add the JS files
    Compiler compiler = new Compiler();
    List<SourceFile> externs = CommandLineRunner.getBuiltinExterns(CompilerOptions.Environment.BROWSER);

    List<SourceFile> inputs = ImmutableList.of(
        SourceFile.fromCode("echo.js", echoJs),
        SourceFile.fromCode("echo-main.js", echoMainJs)
    );

    compiler.compile(externs, inputs, options);

    // Check if the expected error is thrown
    JSError[] errors = compiler.getErrors();
    assertEquals(1, errors.length);
    assertEquals("Property module$exports never defined on module$echo_main", errors[0].description);
}