public void testNodeSetReturnFromExtensionFunction() {
    JXPathContext context = JXPathContext.newContext(new HashMap<>());
    context.getVariables().declareVariable("ems", new Object() {
        public NodeSet observations(ExpressionContext context) {
            List<NodePointer> ptrs = new ArrayList<>();
            // Simulate observations extraction
            ptrs.add(context.getContextNodePointer());
            BasicNodeSet result = new BasicNodeSet();
            for (NodePointer ptr : ptrs) {
                result.add(ptr);
            }
            return result;
        }
    });

    Object result = context.selectNodes("ems:observations()");
    assertTrue(result instanceof List);
    assertEquals(1, ((List<?>) result).size());
    assertTrue(((List<?>) result).get(0) instanceof NodePointer);
}