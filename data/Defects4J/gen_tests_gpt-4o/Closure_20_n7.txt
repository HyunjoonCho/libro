public void testStringConversionOptimization() {
    Object f = new Object() {
        @Override
        public String toString() {
            return "undefined";
        }

        @Override
        public int hashCode() {
            return valueOf() == null ? 0 : valueOf().hashCode();
        }

        public Object valueOf() {
            return null;
        }
    };

    String result = String.valueOf(f);
    assertEquals("[object Object]", result);
}