
import org.apache.commons.math3.ode.FirstOrderDifferentialEquations;
import org.apache.commons.math3.ode.sampling.StepHandler;
import org.apache.commons.math3.ode.sampling.StepInterpolator;
import org.apache.commons.math3.ode.nonstiff.DormandPrince853Integrator;
import org.apache.commons.math3.exception.DimensionMismatchException;
import org.apache.commons.math3.exception.MaxCountExceededException;
import org.apache.commons.math3.exception.NoBracketingException;
import org.junit.Assert;
import org.junit.Test;

public class OdeIntegratorTest {

    @Test
    public void testMissedEvent() throws DimensionMismatchException, 
            MaxCountExceededException, NoBracketingException {

        final double t0 = 1878250320.0000029;
        final double t =  1878250379.9999986;
        
        FirstOrderDifferentialEquations ode = new FirstOrderDifferentialEquations() {
            
            public int getDimension() {
                return 1;
            }
            
            public void computeDerivatives(double t, double[] y, double[] yDot) {
                yDot[0] = y[0] * 1.0e-6;
            }
        };

        // Instantiate the integrator with the same parameters
        DormandPrince853Integrator integrator = new DormandPrince853Integrator(0.0, 100.0, 1.0e-10, 1.0e-10);
        
        double[] y = { 1.0 };
        integrator.setInitialStepSize(60.0);
        
        // Add a step handler to monitor the integration process
        integrator.addStepHandler(new StepHandler() {
            public void handleStep(StepInterpolator interpolator, boolean isLast) {
                if (isLast) {
                    System.out.println("Final time reached: " + interpolator.getCurrentTime());
                }
            }

            public void init(double t0, double[] y0, double t) { }
        });

        // Perform the integration
        double finalT = integrator.integrate(ode, t0, y, t, y);

        // Check the final time against the expected final time
        Assert.assertEquals(t, finalT, 1.0e-6);
    }
}
