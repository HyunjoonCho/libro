
import com.fasterxml.jackson.annotation.JsonInclude;
import com.fasterxml.jackson.annotation.JsonSubTypes;
import com.fasterxml.jackson.annotation.JsonTypeInfo;
import com.fasterxml.jackson.annotation.JsonInclude.Include;
import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.exc.InvalidTypeIdException;
import org.junit.Test;
import static org.junit.Assert.assertEquals;

public class JacksonTest {

    @Test
    public void testDeserializationWithInvalidSubtype() throws Exception {
        ObjectMapper objectMapper = new ObjectMapper();
        objectMapper.configure(DeserializationFeature.FAIL_ON_INVALID_SUBTYPE, false);
        objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
        objectMapper.configure(DeserializationFeature.FAIL_ON_IGNORED_PROPERTIES, false);

        String json1 = "{\"version\":0.0,\"application\":\"123\",\"item\":{\"type\":\"xevent\",\"location\":\"location1\"},\"item2\":{\"type\":\"event\",\"location\":\"location1\"}}";
        CallRecord callRecord1 = objectMapper.readValue(json1, CallRecord.class);
        assertEquals(0.0f, callRecord1.version, 0.0);
        assertEquals("123", callRecord1.application);
        assertEquals(null, callRecord1.item); // "xevent" is an invalid type
        assertEquals("location1", ((Event) callRecord1.item2).location);

        String json2 = "{\"version\":0.0,\"application\":\"123\"},{\"item\":{\"type\":\"xevent\",\"location\":\"location1\"}";
        CallRecord callRecord2 = objectMapper.readValue(json2, CallRecord.class);
        assertEquals(0.0f, callRecord2.version, 0.0);
        assertEquals("123", callRecord2.application);

        String json3 = "{\"item\":{\"type\":\"xevent\",\"location\":\"location1\"}, \"version\":0.0,\"application\":\"123\"}";
        CallRecord callRecord3 = objectMapper.readValue(json3, CallRecord.class);
        assertEquals(0.0f, callRecord3.version, 0.0);
        assertEquals("123", callRecord3.application);
    }
}

@JsonInclude(Include.NON_NULL)
class CallRecord {
    public float version;
    public String application;
    public Item item;
    public Item item2;

    @Override
    public String toString() {
        StringBuilder builder = new StringBuilder();
        builder.append("CallRecord [version=").append(version).append(", ");
        if (application != null) {
            builder.append("application=").append(application).append(", ");
        }
        if (item != null) {
            builder.append("item=").append(item);
        }
        builder.append("]");
        return builder.toString();
    }
}

@JsonTypeInfo(use = JsonTypeInfo.Id.NAME, include = JsonTypeInfo.As.PROPERTY, property = "type", visible = true)
@JsonSubTypes(@JsonSubTypes.Type(value = Event.class, name = Event.TYPE))
interface Item {
}

final class Event implements Item {
    public String location;
    public static final String TYPE = "event";
}
