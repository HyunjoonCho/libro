public void testIncompleteHandlingOfUndefinedNamespaces() throws Exception {
    String xmlString = "<root xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:A=\"http://example.com/A\" xmlns:B=\"http://example.com/B\">" +
            "  <ElementA A:myAttr=\"Mytype\">" +
            "    <B:ElementB>MY VALUE</B:ElementB>" +
            "  </ElementA>" +
            "</root>";

    DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
    DocumentBuilder builder = factory.newDocumentBuilder();
    Document document = builder.parse(new InputSource(new StringReader(xmlString)));

    DOMXPath xpath = new DOMXPath("//@*[starts-with(name(), 'xsi:')]");
    List<Node> nodes = xpath.selectNodes(document.getDocumentElement());

    for (Node node : nodes) {
        String namespaceURI = ((Attr) node).getNamespaceURI();
        String localName = ((Attr) node).getLocalName();
        document.renameNode(node, null, localName);
    }

    xpath = new DOMXPath("//@*[starts-with(name(), 'A:')]");
    nodes = xpath.selectNodes(document.getDocumentElement());

    for (Node node : nodes)