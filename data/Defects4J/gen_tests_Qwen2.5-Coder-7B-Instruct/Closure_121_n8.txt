public void testOverzealousOptimization() throws Exception {
    String jsCode = 
      "var uid;\n" +
      "function reset() {\n" +
      "  uid = Math.random();\n" +
      "}\n" +
      "function doStuff() {\n" +
      "  reset();\n" +
      "  var _uid = uid;\n" +
      "\n" +
      "  if (uid < 0.5) {\n" +
      "    doStuff();\n" +
      "  }\n" +
      "\n" +
      "  if (_uid!== uid) {\n" +
      "    throw'reset() was called';\n" +
      "  }\n" +
      "}\n" +
      "doStuff();";

    ScriptEngine engine = new ScriptEngineManager().getEngineByName("javascript");
    try {
      engine.eval(jsCode);
      fail("Expected exception was not thrown");
    } catch (ScriptException e) {
      assertTrue(e.getMessage().contains("reset() was called"));
    }
  }