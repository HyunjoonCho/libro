public void testResetDefaultNamespaceCausesEndlessLoop() throws Exception {
    DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
    DocumentBuilder builder = factory.newDocumentBuilder();
    Document document = builder.parse(new InputSource(new StringReader(
            "<root xmlns=\"test111\">" +
            "  <child xmlns=\"\"/>" +
            "</root>"
    )));

    XPathFactory xPathfactory = XPathFactory.newInstance();
    XPath xpath = xPathfactory.newXPath();
    xpath.setNamespaceContext(new NamespaceContext() {
        @Override public String getNamespaceURI(String prefix) { return null; }
        @Override public String getPrefix(String namespaceURI) { return null; }
        @Override public Iterator<String> getPrefixes(String namespaceURI) { return Collections.emptyIterator(); }
    });

    Node childNode = (Node) xpath.evaluate("/root/child", document, XPathConstants.NODE);
    assertNotNull(childNode);
    try {
        childNode.getChildNodes().item(0).getParentNode().getFirstChild().getNodeValue();
        fail("Expected an exception to be thrown");
    } catch (NullPointerException e) {
        // Expected exception
    }
}