public void testPreconditionCrash() {
    String jsCode = 
        "var goog = {};"
      + "goog.scope;"
      + ""
      + "var ns = {};"
      + "ns.sub = {};"
      + "/** @constructor */"
      + "ns.sub.C = function() {};"
      + ""
      + "goog.scope(function() {"
      + "  var sub = ns.sub;"
      + "/** @type {sub.C} */"
      + "  var x = null;"
      + "});";

    // This test should cause a Preconditions.checkState exception if the issue still exists
    try {
        Compiler compiler = new Compiler();
        compiler.initOptions(new CompilerOptions());
        compiler.addInput(jsCode, SourceFile.fromCode("test", jsCode));
        compiler.parseInputsAndReportErrors();
        fail("Expected IllegalStateException");
    } catch (IllegalStateException e) {
        // Expected exception
    }
}