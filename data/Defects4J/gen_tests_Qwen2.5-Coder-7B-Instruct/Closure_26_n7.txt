public void testProcessCommonJSModules() throws Exception {
    String jsSource =
      "define(function() { return {\n" +
      "  echo: function(val) {\n" +
      "    window.console.log(val);\n" +
      "  }\n" +
      "}; });\n";

    String mainJsSource =
      "var echo = require('echo');\n" +
      "echo.echo('hello world');\n";

    Compiler compiler = new Compiler();
    compiler.initCompilerOptions();

    List<CompilerInput> inputs = new ArrayList<>();
    inputs.add(new CompilerInput(jsSource, "echo.js", null));
    inputs.add(new CompilerInput(mainJsSource, "echo-main.js", null));

    compiler.compile(inputs, null, null);

    assertTrue(compiler.hasErrors());
    assertEquals(1, compiler.getErrorCount());

    JSError error = compiler.getErrors()[0];
    assertEquals(JSError.ErrorLevel.ERROR, error.level);
    assertEquals("Property module$exports never defined on module$echo_main", error.description);
}