public void testVarCheckCrashWhenUsingModules() throws Exception {
    String jsCode = 
      "var jQuery$$2;\n" +
      "function equal(a, b, c) {}\n" +
      "equal(jQuery(\" <div/> \").length, 1, \"Make sure whitespace is trimmed.\");";

    Compiler compiler = new Compiler();
    compiler.initOptions(new CommandLineRunner().getOptionsForProcessing(null));
    compiler.addInput("core.js", jsCode);

    try {
      compiler.compile();
      fail("Expected internal compiler error");
    } catch (RuntimeException e) {
      assertTrue(e.getMessage().contains("INTERNAL COMPILER ERROR"));
      assertTrue(e.getCause().getMessage().contains("Unexpected variable jQuery$$2"));
    }
  }