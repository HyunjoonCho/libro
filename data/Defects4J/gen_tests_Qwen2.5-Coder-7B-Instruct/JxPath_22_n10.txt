public void testResetDefaultNamespace() throws Exception {
    DocumentBuilderFactory dbFactory = DocumentBuilderFactory.newInstance();
    DocumentBuilder dBuilder = dbFactory.newDocumentBuilder();
    Document doc = dBuilder.parse(new InputSource(new StringReader("<root><child xmlns=\"http://example.com\"/></root>")));
    XPath xpath = XPathFactory.newInstance().newXPath();
    Node childNode = (Node) xpath.evaluate("/root/child", doc, XPathConstants.NODE);

    NamespaceContext context = new NamespaceContext() {
        @Override public String getNamespaceURI(String prefix) { return "http://example.com"; }
        @Override public String getPrefix(String namespaceURI) { return "ex"; }
        @Override public Iterator<String> getPrefixes(String namespaceURI) { return Collections.emptyIterator(); }
    };

    xpath.setNamespaceContext(context);

    try {
        childNode.getAttributes().item(0).getNodeValue();
        fail("Expected exception not thrown");
    } catch (Exception e) {
        assertTrue(e.getMessage().contains("endless loop"));
    }
}