public void testResetDefaultNamespaceCausesInfiniteLoop() throws Exception {
    String xml = "<root><child xmlns=\"http://example.com\"/></root>";
    Document doc = DocumentBuilderFactory.newInstance().newDocumentBuilder().parse(new InputSource(new StringReader(xml)));
    XPath xpath = XPathFactory.newInstance().newXPath();
    xpath.setNamespaceContext(new NamespaceContext() {
        @Override public String getNamespaceURI(String prefix) {
            return "http://example.com";
        }
        @Override public String getPrefix(String namespaceURI) { throw new UnsupportedOperationException(); }
        @Override public Iterator<String> getPrefixes(String namespaceURI) { throw new UnsupportedOperationException(); }
    });
    Node child = (Node) xpath.evaluate("/root/child", doc, XPathConstants.NODE);
    try {
        child.getParentNode().setPrefix(null); // This should cause an infinite loop
        fail("Expected an exception");
    } catch (Exception e) {
        // Expected exception
    }
}