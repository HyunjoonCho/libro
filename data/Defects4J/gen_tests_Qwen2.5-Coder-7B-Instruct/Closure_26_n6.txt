public void testProcessCommonJSModules() throws Exception {
    String echoJs = "define(function() { return {\n" +
                    "  echo: function(val) {\n" +
                    "    window.console.log(val);\n" +
                    "  }\n" +
                    "} });";

    String echoMainJs = "var echo = require('echo');\n" +
                        "echo.echo('hello world');";

    List<String> jsFiles = Arrays.asList(echoJs, echoMainJs);

    // Compile JS files with --process_common_js_modules option
    Compiler compiler = new Compiler();
    List<CompilerInput> inputs = jsFiles.stream()
           .map(CompilerInput::new)
           .collect(Collectors.toList());
    compiler.compile(inputs, null, null, null, null, null, null, null, null,
            Collections.singletonList("--process_common_js_modules"), null);

    // Check if there is an error about undefined module$exports
    boolean hasError = compiler.getErrorManager().getErrors().stream()
           .anyMatch(error -> error.getType() == ErrorType.JSC_UNDEFINED_PROPERTY &&
                    error.getMessage().contains("Property module$exports never defined"));

    assertFalse(hasError);
}