public void testVarCheckCrashWhenUsingModules() throws Exception {
    String jsCode =
      "var jQuery = function(selector) { return {}; }; " +
      "function equal(actual, expected, message) { } " +
      "equal(jQuery(' <div/> ').length, 1, 'Make sure whitespace is trimmed.');";

    Compiler compiler = new Compiler();
    compiler.init(
      Collections.<JSSourceFile>emptyList(),
      ImmutableList.of(JSSourceFile.fromCode("test.js", jsCode)),
      null);

    compiler.setOptionsForTest(new CompilerOptions());
    compiler.addCompilationLevel(CompilationLevel.ADVANCED_OPTIMIZATIONS);
    compiler.addOutputFormatter(new PrettyPrintFormatter(System.err));
    compiler.setErrorHandler(ErrorManager.DEFAULT);

    try {
      compiler.compile();
      fail("Expected compilation error");
    } catch (RuntimeException e) {
      assertTrue(e.getMessage().contains("INTERNAL COMPILER ERROR"));
      assertTrue(e.getCause().getMessage().contains("Unexpected variable jQuery$$2"));
    }
}