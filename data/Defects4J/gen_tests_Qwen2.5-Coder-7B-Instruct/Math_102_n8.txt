public void testChiSquareWithRescaling() throws Exception {
    ChiSquareTestImpl testStatistic = new ChiSquareTestImpl();
    long[] observed = { 500, 623, 72, 70, 31 };
    double[] expected = { 485, 541, 82, 61, 37 };

    double chiSquareValue = testStatistic.chiSquare(expected, observed);

    // Calculate the correct chi-square value using R-like logic
    double sumObserved = Arrays.stream(observed).asDoubleStream().sum();
    double sumExpected = Arrays.stream(expected).asDoubleStream().sum();
    double[] rescaledExpected = Arrays.stream(expected).map(e -> e * (sumObserved / sumExpected)).toArray();

    double correctChiSquareValue = 0;
    for (int i = 0; i < observed.length; i++) {
        double dev = (observed[i] - rescaledExpected[i]);
        correctChiSquareValue += dev * dev / rescaledExpected[i];
    }

    assertEquals("chi-square test statistic", correctChiSquareValue, chiSquareValue, 1E-10);
}