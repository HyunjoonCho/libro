public void testVarCheckCrashWithModules() throws Exception {
    String jsCode = 
        "var jQuery = function(){};" +
        "(function($){" +
        "  $.fn = {};" +
        "})(jQuery);" +
        "jQuery(' <div/> ').length;";
    
    Compiler compiler = new Compiler();
    compiler.initOptions(new CommandLineRunner().getOptionsForInputType(SourceKind.JS));
    compiler.addInputsFromText(jsCode, SourceFile.fromCode("test.js", jsCode));
    compiler.setModuleGraph(new ModuleGraph());
    compiler.setModuleMetadataMap(new HashMap<String, List<SourceFile>>());
    try {
      compiler.compile();
      fail("Expected internal compiler error");
    } catch (RuntimeException e) {
      assertTrue(e.getMessage().contains("INTERNAL COMPILER ERROR"));
      assertTrue(e.getCause().getMessage().contains("Unexpected variable jQuery$$2"));
    }
}