public void testVarCheckCrashWithModules() throws Exception {
    String jsCode = 
        "var jQuery = function() {};" +
        "jQuery.prototype.length = 1;" +
        "function equal(a, b, msg) { console.log(msg); }" +
        "equal(jQuery(' <div/> ').length, 1, 'Make sure whitespace is trimmed.');";

    Compiler compiler = new Compiler();
    compiler.initOptions(new Options());
    compiler.addInput(jsCode, "core.js", SourceKind.EXTERNAL);

    compiler.setModuleGraph(new ModuleGraph(
        ImmutableMap.of(
            "jquery", new Module("jquery"),
            "core", new Module("core").addDependency("jquery")
        )
    ));

    try {
        compiler.compile();
        fail("Expected compilation error due to VarCheck crash");
    } catch (RuntimeException e) {
        assertTrue(e.getMessage().contains("INTERNAL COMPILER ERROR"));
    }
}