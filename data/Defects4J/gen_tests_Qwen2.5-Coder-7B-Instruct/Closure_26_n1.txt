public void testProcessCommonJSModules() throws Exception {
    String jsCode = 
      "define(function() { return {\n" +
      "  echo: function(val) {\n" +
      "    window.console.log(val);\n" +
      "  }\n" +
      "}});";
    
    String mainJsCode = 
      "var echo = require('echo');\n" +
      "echo.echo('hello world');";

    List<String> inputs = Arrays.asList(jsCode, mainJsCode);
    Compiler compiler = new Compiler();
    compiler.initLogger(new PrintStream(System.err));
    compiler.initOptions(null);
    compiler.setCommandLineFlags("--formatting=PRETTY_PRINT", "--jscomp_error=checkTypes", "--compilation_level=SIMPLE_OPTIMIZATIONS", "--transform_amd_modules", "--process_common_js_modules", "--js=" + inputs.get(0), "--js=" + inputs.get(1), "--common_js_entry_module=echo-main.js");

    boolean success = compiler.compile(inputs, null, null);
    assertFalse(success);
}