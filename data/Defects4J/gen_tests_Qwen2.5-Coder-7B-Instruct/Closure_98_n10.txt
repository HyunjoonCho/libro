public void testBadVariableInliningInClosure() throws Exception {
    StringWriter sw = new StringWriter();
    PrintWriter pw = new PrintWriter(sw);
    Compiler compiler = new Compiler();
    compiler.initLogger(pw);

    String jsCode = "function foo() {\n" +
                    "  var arr = [1, 2, 3, 4, 5];\n" +
                    "  for (var i = 0, l = arr.length; i < l; i++) {\n" +
                    "    var j = arr[i];\n" +
                    "    (function() {\n" +
                    "      var k = j;\n" +
                    "      setTimeout(function() { console.log(k); }, 0);\n" +
                    "    })();\n" +
                    "  }\n" +
                    "}\n" +
                    "foo();";

    CompilerOptions options = new CompilerOptions();
    Result result = compiler.compile(new JavaScriptInput(jsCode, null, null),
                                    Collections.singletonList(new JsOutputFile("default.js")),
                                    options);

    assertTrue(result.success);
    assertFalse(sw.toString().contains("k will get incorrectly inlined."));
}