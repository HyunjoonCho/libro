public void testBadVariableInliningInClosure() {
    StringBuilder sb = new StringBuilder();
    sb.append("function foo() {\n");
    sb.append(" var arr = [1, 2, 3, 4, 5];\n");
    sb.append(" for (var i = 0, l = arr.length; i < l; i++) {\n");
    sb.append(" var j = arr[i];\n");
    sb.append(" (function() {\n");
    sb.append(" var k = j;\n");
    sb.append(" setTimeout(function() { console.log(k); }, 0);\n");
    sb.append(" })();\n");
    sb.append(" }\n");
    sb.append("}\n");
    sb.append("foo();");

    String jsCode = sb.toString();

    try {
      JavaScriptEngine engine = new JavaScriptEngine();
      engine.eval(jsCode);
      fail("Expected exception not thrown");
    } catch (JavaScriptException e) {
      assertTrue(e.getMessage().contains("k" + " will get incorrectly inlined"));
    }
  }