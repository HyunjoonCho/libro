public void testProcessCommonJSModules() throws Exception {
  String input =
      "define(function() { return {\n" +
      "  echo: function(val) {\n" +
      "    window.console.log(val);\n" +
      "  }\n" +
      "}});\n" +
      "\n" +
      "var echo = require('echo');\n" +
      "echo.echo('hello world');";

  String expectedOutput =
      "define(function() { return {\n" +
      "  echo: function(val) {\n" +
      "    window.console.log(val);\n" +
      "  }\n" +
      "}});\n" +
      "\n" +
      "(function() {\n" +
      "  var echo = require('echo');\n" +
      "  echo.echo('hello world');\n" +
      "})();";

  Compiler compiler = new Compiler();
  compiler.initOptions(new CompilerOptions());
  compiler.addInputSource(SourceFile.fromCode("echo.js", input));
  compiler.compile();

  List<CompilerInput> inputs = compiler.getInputsInOrder();
  assertEquals(expectedOutput, inputs.get(0).getCode());
}