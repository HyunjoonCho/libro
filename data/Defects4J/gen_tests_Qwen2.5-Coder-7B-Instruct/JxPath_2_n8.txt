public void testExtensionFunctionWithNodeSet() throws Exception {
    JXPathContext context = JXPathContext.newContext(new Object());

    // Mock the extension function to return a BasicNodeSet
    Method method = JXPathContext.class.getDeclaredMethod("registerFunction", String.class, Class.class, Object.class);
    method.setAccessible(true);
    method.invoke(context, "ems", NodeSet.class, new TestNodeSet());

    // Evaluate the XPath expression
    List<?> result = (List<?>) context.getValue("//ems:observations()");

    // Verify the result
    assertNotNull(result);
    assertEquals(1, result.size());
    assertTrue(result.get(0) instanceof BasicNodeSet);
}

// Mock class to simulate the return value of the extension function
private static class TestNodeSet extends BasicNodeSet {
    @Override
    public Iterator<NodePointer> iterator() {
        List<NodePointer> pointers = new ArrayList<>();
        pointers.add(NodePointer.nodePointerFor(null, null));
        return pointers.iterator();
    }
}