public void testVarCheckCrashWithModules() {
    String jqueryCode = "var jQuery = function() { return 'jQuery'; };";
    String coreCode = "equal(jQuery('<div/>').length, 1, 'Make sure whitespace is trimmed.');";

    try {
        compiler.compile(jqueryCode, "jquery.js", "-1");
        compiler.compile(coreCode, "core.js", "1:jquery");
        fail("Expected a RuntimeException to be thrown");
    } catch (RuntimeException e) {
        assertTrue(e.getMessage(), e.getMessage().contains("Unexpected variable jQuery$$2"));
    }
}