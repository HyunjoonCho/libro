public void testNodeSetReturnedByExtensionFunction() {
    JXPathContext context = new JXPathContext();
    context.setExpressionCache(new XPathExpressionCache() {
        public XPathExpression compile(String expression, Class<?> requiredType) {
            if ("ems:observations()".equals(expression)) {
                return new XPathExpression() {
                    public Object evaluate(Object contextNode) {
                        return observations((ExpressionContext) contextNode);
                    }
                };
            }
            return null;
        }
    });
    List<Node> nodes = context.selectNodes("/test:nodeSet()/ems:observations()");
    assertEquals(1, nodes.size());
    NodeSet nodeSet = (NodeSet) nodes.get(0);
    assertTrue(nodeSet.iterator().hasNext());
}