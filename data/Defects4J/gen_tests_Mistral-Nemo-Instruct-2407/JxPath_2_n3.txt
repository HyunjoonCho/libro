public void testNodeSetFromExtensionFunction() {
    // given
    ExpressionContext context = mock(ExpressionContext.class);
    NodePointer nodePointer = mock(NodePointer.class);
    List<NodePointer> ptrs = Arrays.asList(nodePointer);
    when(context.getContextNodePointer()).thenReturn(nodePointer);
    when(extractObservations(nodePointer, new ArrayList<NodePointer>())).thenReturn(ptrs);

    JXPathContext jxpathContext = mock(JXPathContext.class);
    when(jxpathContext.selectNodes("ems:observations()")).thenReturn(new BasicNodeSet(ptrs));

    // when
    NodeSet nodeSet = jxpathContext.selectNodes("ems:observations()");

    // then
    assertEquals(1, nodeSet.size());
    assertTrue(nodeSet.iterator().next() == nodePointer);
}