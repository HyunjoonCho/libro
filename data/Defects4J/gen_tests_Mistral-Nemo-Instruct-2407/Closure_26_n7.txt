public void testProcessCommonJSModulesFailure() {
    // Arrange
    String echoJS = "define(function() { return { echo: function(val) { window.console.log(val); } }; });";
    String echoMainJS = "var echo = require('echo'); echo.echo('hello world');";

    // Act
    String[] args = {
        "--formatting=PRETTY_PRINT",
        "--jscomp_error=checkTypes",
        "--compilation_level=SIMPLE_OPTIMIZATIONS",
        "--transform_amd_modules",
        "--process_common_js_modules",
        "--js=echo.js",
        "--js=echo-main.js",
        "--common_js_entry_module=echo-main.js"
    };
    // Assert (expecting the error as described in the bug report)
    assertTrue(Compiler.compile(args, echoJS, echoMainJS).contains("echo-main.js:1: ERROR - Property module$exports never defined on module$echo_main"));
}